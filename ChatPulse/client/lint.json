[{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\App.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'useRef' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":44,"suggestions":[{"messageId":"removeVar","data":{"varName":"useRef"},"fix":{"range":[35,43],"text":""},"desc":"Remove unused variable 'useRef'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'socket' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":24,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"socket"},"fix":{"range":[1156,1162],"text":""},"desc":"Remove unused variable 'socket'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchContacts'. Either include it or remove the dependency array.","line":58,"column":6,"nodeType":"ArrayExpression","endLine":58,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchContacts]","fix":{"range":[2592,2594],"text":"[fetchContacts]"}}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\nimport ContactList from './components/ContactList';\nimport ChatWindow from './components/ChatWindow';\nimport GroupChatWindow from './components/GroupChatWindow';\nimport CreateGroupModal from './components/CreateGroupModal';\nimport MemoTable from './components/MemoTable';\nimport DiaryTable from './components/DiaryTable';\nimport MomentsFeed from './components/MomentsFeed';\nimport SettingsPanel from './components/SettingsPanel';\nimport ChatSettingsDrawer from './components/ChatSettingsDrawer';\nimport AddCharacterModal from './components/AddCharacterModal';\nimport './App.css';\nimport { MessageSquare, Users, Compass, Settings, UserPlus, Globe, UsersRound } from 'lucide-react';\nimport { useLanguage } from './LanguageContext';\n\nconst API_URL = 'http://localhost:8000/api';\nconst WS_URL = 'ws://localhost:8000';\n\nfunction App() {\n  const { t, lang, toggleLanguage } = useLanguage();\n  const [activeTab, setActiveTab] = useState('chats'); // 'chats', 'contacts', 'settings'\n  const [activeContactId, setActiveContactId] = useState(null);\n  const [contacts, setContacts] = useState([]);\n  const [socket, setSocket] = useState(null);\n  const [newIncomingMessage, setNewIncomingMessage] = useState(null);\n  const [activeDrawer, setActiveDrawer] = useState(null); // 'memo', 'diary', or null\n  const [userProfile, setUserProfile] = useState(null);\n  const [engineState, setEngineState] = useState({});\n  const [showAddCharModal, setShowAddCharModal] = useState(false);\n  const [showCreateGroupModal, setShowCreateGroupModal] = useState(false);\n  const [groups, setGroups] = useState([]);\n  const [activeGroupId, setActiveGroupId] = useState(null);\n  const [newGroupMessage, setNewGroupMessage] = useState(null);\n  const [groupTyping, setGroupTyping] = useState({}); // { groupId: [{ sender_id, name }, ...] }\n\n  const fetchContacts = () => {\n    fetch(`${API_URL}/characters`)\n      .then(res => res.json())\n      .then(data => {\n        setContacts(data);\n        if (activeContactId && !data.find(c => c.id === activeContactId)) {\n          setActiveContactId(null);\n        }\n      })\n      .catch(err => console.error('Failed to load contacts:', err));\n  };\n\n  // 1. Fetch Contacts (Characters) and Profile on mount\n  useEffect(() => {\n    fetchContacts();\n    fetch(`${API_URL}/user`)\n      .then(res => res.json())\n      .then(data => setUserProfile(data));\n    fetch(`${API_URL}/groups`)\n      .then(res => res.json())\n      .then(data => setGroups(data))\n      .catch(err => console.error('Failed to load groups:', err));\n  }, []);\n\n  // 2. Setup WebSocket for real-time messages\n  useEffect(() => {\n    const ws = new WebSocket(WS_URL);\n    ws.onmessage = (event) => {\n      try {\n        const msg = JSON.parse(event.data);\n        if (msg.type === 'new_message') {\n          setNewIncomingMessage(msg.data);\n        } else if (msg.type === 'engine_state') {\n          setEngineState(msg.data);\n        } else if (msg.type === 'group_message') {\n          setNewGroupMessage(msg.data);\n        } else if (msg.type === 'group_typing') {\n          setGroupTyping(prev => {\n            const key = msg.data.group_id;\n            const current = prev[key] || [];\n            if (current.find(t => t.sender_id === msg.data.sender_id)) return prev;\n            return { ...prev, [key]: [...current, msg.data] };\n          });\n        } else if (msg.type === 'group_typing_stop') {\n          setGroupTyping(prev => {\n            const key = msg.data.group_id;\n            return { ...prev, [key]: (prev[key] || []).filter(t => t.sender_id !== msg.data.sender_id) };\n          });\n        } else if (msg.type === 'wallet_sync') {\n          const { characterId, characterWallet, userWallet } = msg.data;\n          if (characterId && characterWallet !== null && characterWallet !== undefined) {\n            setContacts(prev => prev.map(c => c.id === characterId ? { ...c, wallet: characterWallet } : c));\n          }\n          if (userWallet !== null && userWallet !== undefined) {\n            setUserProfile(prev => prev ? { ...prev, wallet: userWallet } : prev);\n          }\n        }\n      } catch (e) {\n        console.error('WS Parse Error', e);\n      }\n    };\n    setSocket(ws);\n    return () => ws.close();\n  }, []);\n\n  // Update contact last message preview on new incoming message\n  useEffect(() => {\n    if (newIncomingMessage) {\n      setContacts(prev => prev.map(c => {\n        if (c.id === newIncomingMessage.character_id) {\n          return {\n            ...c,\n            lastMessage: newIncomingMessage.content,\n            time: new Date(newIncomingMessage.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),\n            unread: c.id === activeContactId ? 0 : (c.unread || 0) + 1\n          };\n        }\n        return c;\n      }));\n    }\n  }, [newIncomingMessage, activeContactId]);\n\n  return (\n    <div className=\"app-container\">\n      {/* 1. Very Left Sidebar (Navigation) */}\n      <nav className=\"sidebar-nav\">\n        <div className=\"my-avatar\" onClick={() => setActiveTab('settings')} style={{ cursor: 'pointer' }}>\n          <img src={userProfile?.avatar || \"https://api.dicebear.com/7.x/notionists/svg?seed=User\"} alt=\"Me\" />\n        </div>\n        <div className=\"nav-icons\">\n          <button className={`nav-icon ${activeTab === 'chats' ? 'active' : ''}`} onClick={() => setActiveTab('chats')} title={lang === 'en' ? 'Chats 鈥?View conversations' : '鑱婂ぉ 鈥?鏌ョ湅浼氳瘽鍒楄〃'}>\n            <MessageSquare size={24} />\n          </button>\n          <button className={`nav-icon ${activeTab === 'contacts' ? 'active' : ''}`} onClick={() => setActiveTab('contacts')} title={lang === 'en' ? 'Contacts 鈥?Manage characters & groups' : '閫氳褰?鈥?绠＄悊瑙掕壊鍜岀兢鑱?}>\n            <Users size={24} />\n          </button>\n          <button className={`nav-icon ${activeTab === 'discover' ? 'active' : ''}`} onClick={() => setActiveTab('discover')} title={lang === 'en' ? 'Discover 鈥?Moments feed' : '鍙戠幇 鈥?鏈嬪弸鍦堝姩鎬?}>\n            <Compass size={24} />\n          </button>\n        </div>\n        <div className=\"nav-icons-bottom\">\n          <button className=\"nav-icon\" onClick={toggleLanguage} title={t('Toggle Language')}>\n            <Globe size={24} />\n            <span style={{ fontSize: '10px', marginTop: '4px', fontWeight: 'bold' }}>{lang === 'en' ? '涓? : 'EN'}</span>\n          </button>\n          <button className={`nav-icon ${activeTab === 'settings' ? 'active' : ''}`} onClick={() => setActiveTab('settings')} title={lang === 'en' ? 'Settings 鈥?Global configuration' : '璁剧疆 鈥?鍏ㄥ眬璁剧疆'}>\n            <Settings size={24} />\n          </button>\n        </div>\n      </nav>\n\n      {/* 2. Middle Column (List) */}\n      <div className=\"middle-column\" style={activeTab === 'contacts' ? { width: 'auto', flex: 1, borderRight: 'none' } : {}}>\n        <div className=\"search-bar-container\">\n          <input type=\"text\" className=\"search-bar\" placeholder={t('Search') || 'Search'} />\n        </div>\n        <div className=\"list-container\">\n          {activeTab === 'chats' && (\n            <ContactList\n              contacts={contacts}\n              activeId={activeContactId}\n              engineState={engineState}\n              onSelect={(id) => {\n                setActiveContactId(id);\n                // Clear unread badge\n                setContacts(prev => prev.map(c => c.id === id ? { ...c, unread: 0 } : c));\n              }}\n            />\n          )}\n          {activeTab === 'chats' && groups.length > 0 && (\n            <div style={{ borderTop: '1px solid #eee' }}>\n              <div style={{ padding: '5px 15px', color: '#999', fontSize: '11px' }}>\n                {lang === 'en' ? 'Group Chats' : '缇よ亰'}\n              </div>\n              {groups.map(g => (\n                <div\n                  key={g.id}\n                  className={`contact-item ${activeGroupId === g.id ? 'active' : ''}`}\n                  onClick={() => { setActiveGroupId(g.id); setActiveContactId(null); }}\n                >\n                  <div className=\"contact-avatar\">\n                    <UsersRound size={24} style={{ padding: '8px', background: '#7B9FE0', borderRadius: '6px', color: '#fff' }} />\n                  </div>\n                  <div className=\"contact-info\">\n                    <div className=\"contact-name\">{g.name}</div>\n                    <div className=\"contact-preview\" style={{ fontSize: '12px', color: '#999' }}>({g.members?.length || 0})</div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n          {activeTab === 'contacts' && (\n            <div style={{ paddingTop: '10px' }}>\n              <div style={{ padding: '5px 15px', color: '#999', fontSize: '13px', backgroundColor: '#ebebeb', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n                <span>{t('All Contacts') || 'All Contacts'}</span>\n                <button\n                  onClick={() => setShowAddCharModal(true)}\n                  style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#7B9FE0', padding: 0 }}\n                  title={lang === 'en' ? 'Add new AI character' : '娣诲姞鏂扮殑 AI 瑙掕壊'}\n                >\n                  <UserPlus size={16} />\n                </button>\n              </div>\n              {contacts.map(c => (\n                <div key={c.id} className=\"contact-item\" onClick={() => { setActiveContactId(c.id); setActiveTab('chats'); }}>\n                  <div className=\"contact-avatar\">\n                    <img src={c.avatar} alt={c.name} />\n                  </div>\n                  <div className=\"contact-info\" style={{ display: 'flex', alignItems: 'center' }}>\n                    <span className=\"contact-name\" style={{ fontSize: '16px' }}>{c.name}</span>\n                  </div>\n                </div>\n              ))}\n              <div style={{ padding: '5px 15px', color: '#999', fontSize: '13px', backgroundColor: '#ebebeb', display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '10px' }}>\n                <span>{lang === 'en' ? 'Group Chats' : '缇よ亰'}</span>\n                <button\n                  onClick={() => setShowCreateGroupModal(true)}\n                  style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#7B9FE0', padding: 0 }}\n                  title={lang === 'en' ? 'Create Group' : '鍒涘缓缇よ亰'}\n                >\n                  <UsersRound size={16} />\n                </button>\n              </div>\n              {groups.map(g => (\n                <div key={g.id} className=\"contact-item\" onClick={() => { setActiveGroupId(g.id); setActiveContactId(null); setActiveTab('chats'); }}>\n                  <div className=\"contact-avatar\">\n                    <UsersRound size={24} style={{ padding: '8px', background: '#7B9FE0', borderRadius: '6px', color: '#fff' }} />\n                  </div>\n                  <div className=\"contact-info\" style={{ display: 'flex', alignItems: 'center' }}>\n                    <span className=\"contact-name\" style={{ fontSize: '16px' }}>{g.name}</span>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n          {activeTab === 'discover' && (\n            <div className=\"contact-item active\">\n              <Compass size={24} style={{ marginRight: '10px', color: '#7B9FE0' }} />\n              <div className=\"contact-info\">\n                <div className=\"contact-name\">{t('Moments')}</div>\n              </div>\n            </div>\n          )}\n          {activeTab === 'settings' && (\n            <div className=\"contact-item active\">\n              <Settings size={24} style={{ marginRight: '10px', color: '#7B9FE0' }} />\n              <div className=\"contact-info\">\n                <div className=\"contact-name\">{t('Settings')}</div>\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n\n\n\n      {/* 3. Right Column (Chat Area / Content) 鈥?hidden on contacts tab */}\n      {activeTab !== 'contacts' && (\n        <div className=\"right-column\" style={{ flexDirection: 'row', backgroundColor: activeTab === 'settings' ? '#f5f5f5' : '#fff' }}>\n          {activeTab === 'settings' ? (\n            <div style={{ flex: 1, height: '100%', overflow: 'auto' }}>\n              <SettingsPanel\n                apiUrl={API_URL}\n                contacts={contacts}\n                onCharactersUpdate={() => {\n                  fetchContacts(); // Refetch if deleted\n                }}\n                onProfileUpdate={setUserProfile}\n              />\n            </div>\n          ) : activeTab === 'discover' ? (\n            <div style={{ flex: 1, height: '100%', overflow: 'hidden' }}>\n              <MomentsFeed apiUrl={API_URL} userProfile={userProfile} />\n            </div>\n          ) : activeContactId && activeTab === 'chats' ? (\n            <div style={{ flex: 1, display: 'flex', flexDirection: 'row', height: '100%', minWidth: 0 }}>\n              <div style={{ flex: 1, display: 'flex', flexDirection: 'column', minWidth: 0 }}>\n                <ChatWindow\n                  contact={contacts.find(c => c.id === activeContactId)}\n                  allContacts={contacts}\n                  userAvatar={userProfile?.avatar}\n                  apiUrl={API_URL}\n                  newIncomingMessage={newIncomingMessage}\n                  engineState={engineState}\n                  onToggleMemo={() => setActiveDrawer(activeDrawer === 'memo' ? null : 'memo')}\n                  onToggleDiary={() => setActiveDrawer(activeDrawer === 'diary' ? null : 'diary')}\n                  onToggleSettings={() => setActiveDrawer(activeDrawer === 'settings' ? null : 'settings')}\n                />\n              </div>\n              {activeDrawer === 'memo' && (\n                <MemoTable\n                  contact={contacts.find(c => c.id === activeContactId)}\n                  apiUrl={API_URL}\n                  onClose={() => setActiveDrawer(null)}\n                />\n              )}\n              {activeDrawer === 'diary' && (\n                <DiaryTable\n                  contact={contacts.find(c => c.id === activeContactId)}\n                  apiUrl={API_URL}\n                  onClose={() => setActiveDrawer(null)}\n                />\n              )}\n              {activeDrawer === 'settings' && (\n                <ChatSettingsDrawer\n                  contact={contacts.find(c => c.id === activeContactId)}\n                  apiUrl={API_URL}\n                  onClose={() => setActiveDrawer(null)}\n                  onClearHistory={() => {\n                    setActiveDrawer(null);\n                    setActiveContactId(null);\n                    fetchContacts(); // Re-pull character data so stats show as reset immediately\n                  }}\n                />\n              )}\n            </div>\n          ) : activeGroupId && activeTab === 'chats' ? (\n            <div style={{ flex: 1, display: 'flex', flexDirection: 'row', height: '100%', minWidth: 0 }}>\n              <GroupChatWindow\n                group={groups.find(g => g.id === activeGroupId)}\n                apiUrl={API_URL}\n                allContacts={contacts}\n                userProfile={userProfile}\n                newGroupMessage={newGroupMessage}\n                typingIndicators={groupTyping[activeGroupId] || []}\n              />\n            </div>\n          ) : (\n            <div className=\"empty-chat-state\">\n              <MessageSquare size={64} className=\"empty-icon\" />\n              <p>ChatPulse</p>\n            </div>\n          )}\n        </div>\n      )}\n\n      <AddCharacterModal\n        isOpen={showAddCharModal}\n        onClose={() => setShowAddCharModal(false)}\n        apiUrl={API_URL}\n        onAdd={(newChar) => {\n          setContacts(prev => [...prev, newChar]);\n        }}\n      />\n\n      {showCreateGroupModal && (\n        <CreateGroupModal\n          apiUrl={API_URL}\n          contacts={contacts}\n          onClose={() => setShowCreateGroupModal(false)}\n          onCreate={(group) => {\n            setGroups(prev => [group, ...prev]);\n            setShowCreateGroupModal(false);\n            setActiveGroupId(group.id);\n            setActiveContactId(null);\n            setActiveTab('chats');\n          }}\n        />\n      )}\n    </div>\n  );\n}\n\nexport default App;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\LanguageContext.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":115,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":115,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useState, useContext, useEffect } from 'react';\r\n\r\nconst LanguageContext = createContext();\r\n\r\nconst translations = {\r\n    // Common\r\n    'Save': { en: 'Save', zh: '淇濆瓨' },\r\n    'Cancel': { en: 'Cancel', zh: '鍙栨秷' },\r\n    'Edit': { en: 'Edit', zh: '缂栬緫' },\r\n    'Delete': { en: 'Delete', zh: '鍒犻櫎' },\r\n    'Send': { en: 'Send', zh: '鍙戦€? },\r\n    'Loading': { en: 'Loading...', zh: '鍔犺浇涓?..' },\r\n\r\n    // Tabs\r\n    'Chats': { en: 'Chats', zh: '鑱婂ぉ' },\r\n    'Contacts': { en: 'Contacts', zh: '鑱旂郴浜? },\r\n    'Moments': { en: 'Moments', zh: '鏈嬪弸鍦? },\r\n    'Settings': { en: 'Settings', zh: '璁剧疆' },\r\n\r\n    // Settings Panel\r\n    'Export Data': { en: 'Export Data', zh: '瀵煎嚭鏁版嵁' },\r\n    'Deep Wipe': { en: 'Deep Wipe', zh: '娣卞害娓呯悊' },\r\n    'Characters': { en: 'Characters', zh: '瑙掕壊' },\r\n    'Add Character': { en: 'Add Character', zh: '娣诲姞瑙掕壊' },\r\n    'User Profile': { en: 'User Profile', zh: '鐢ㄦ埛妗ｆ' },\r\n    'Name': { en: 'Name', zh: '鍚嶇О' },\r\n    'Avatar URL': { en: 'Avatar URL', zh: '澶村儚 URL' },\r\n    'Bio': { en: 'Bio', zh: '涓€х鍚? },\r\n    'Theme': { en: 'Theme', zh: '涓婚' },\r\n\r\n    // Add / Edit Character Form\r\n    'Persona': { en: 'Persona', zh: '瑙掕壊璁惧畾 (Persona)' },\r\n    'World Info / Scenario': { en: 'World Info / Scenario', zh: '涓栫晫璁惧畾 / 鍦烘櫙' },\r\n    'API Endpoint': { en: 'API Endpoint (e.g. https://api.openai.com/v1)', zh: 'API Endpoint (濡? https://api.openai.com/v1)' },\r\n    'Memory API Endpoint': { en: 'Memory API Endpoint', zh: '璁板繂鎻愬彇 API Endpoint (鍙€?' },\r\n    'API Key': { en: 'API Key', zh: 'API Key' },\r\n    'Memory API Key': { en: 'Memory API Key', zh: '璁板繂鎻愬彇 API Key (鍙€?' },\r\n    'Model Name': { en: 'Model Name (e.g. gpt-4o)', zh: '鑱婂ぉ妯″瀷鍚嶇О (渚嬪: gpt-4o)' },\r\n    'Memory Model Name': { en: 'Memory Model Name', zh: '璁板繂妯″瀷 (寤鸿: o1-mini绛夋帹鐞嗘ā鍨?' },\r\n    'Fetch Models': { en: 'Fetch List', zh: '鎷夊彇鍒楄〃' },\r\n    'System Guidelines': { en: 'System Guidelines (Mandatory logic for background events)', zh: '绯荤粺鍑嗗垯 (鍚庡彴浜嬩欢杩愯鐨勫己鍒堕€昏緫)' },\r\n    'Advanced Config': { en: 'Advanced Engine Configuration', zh: '楂樼骇寮曟搸閰嶇疆' },\r\n    'Max Output Tokens': { en: 'Max Output Tokens', zh: '鏈€澶ц緭鍑?Token 闄愬埗' },\r\n\r\n    // Systems Toggles\r\n    'Disable Background Engine': { en: '馃毃 Disable Entire Background Engine (Sleep Mode)', zh: '馃毃 绂佺敤璇ヨ鑹茬殑鎵€鏈夊悗鍙版椿鍔?(浼戠湢妯″紡)' },\r\n    'Toggle Proactive Messages': { en: 'Enable Proactive Messaging (Random initiated messages)', zh: '寮€鍚富鍔ㄥ彂娑堟伅 (闅忔満鍙戣捣璇濋)' },\r\n    'Toggle Timer Actions': { en: 'Enable Self-Scheduled Timers ([TIMER] tags)', zh: '鍏佽瑙掕壊鑷畾涔夌瓑寰呮椂闂?(浣跨敤 [TIMER] 鏍囩)' },\r\n    'Toggle Pressure System': { en: 'Enable Pressure System (Panic mode if ignored)', zh: '寮€鍚儏缁帇鍔涚郴缁?(琚棤瑙嗘椂浼氭劅鍒扮劍铏?' },\r\n    'Toggle Jealousy System': { en: 'Enable Jealousy System (Interruption when talking to others)', zh: '寮€鍚悆閱嬬郴缁?(鍚屽埆浜鸿亰澶╂椂鏈夋鐜囨墦鏂?' },\r\n\r\n    // Chat & Drawers\r\n    'Chat Settings': { en: 'Chat Settings', zh: '鑱婂ぉ璁剧疆' },\r\n    'Memories': { en: 'Memories', zh: '娼滄剰璇嗚蹇? },\r\n    'Secret Diary': { en: 'Secret Diary', zh: '绉佸瘑鏃ヨ鏈? },\r\n    'Send Transfer': { en: 'Send Transfer', zh: '鍙戦€佽浆璐?绾㈠寘' },\r\n    'Hide Old Messages': { en: 'Hide Old Messages', zh: '闅愯棌鏃ф秷鎭? },\r\n    'No moments yet': { en: 'No moments yet. Your friends are quiet today.', zh: '杩樻病鏈変换浣曞姩鎬佸摝銆? },\r\n    'Share something new': { en: 'Share something new...', zh: '璇寸偣浠€涔?..' },\r\n    'Post': { en: 'Post', zh: '鍙戝竷' },\r\n    'Type a message': { en: 'Type a message...', zh: '杈撳叆娑堟伅...' },\r\n    'Connecting': { en: 'Connecting...', zh: '杩炴帴涓?..' },\r\n    'Thinking': { en: 'Thinking...', zh: '瀵规柟姝ｅ湪杈撳叆...' },\r\n    'Typing': { en: 'typing...', zh: '姝ｅ湪杈撳叆...' },\r\n\r\n    // Diary & Memory specific\r\n    'Unlock Diary': { en: 'Unlock Secret Diary', zh: '瑙ｉ攣绉佸瘑鏃ヨ' },\r\n    'Diary Locked': { en: 'Diary is Locked 馃敀', zh: '鏃ヨ宸查攣瀹?馃敀' },\r\n    'Password': { en: 'Password', zh: '瀵嗙爜' },\r\n    'Unlock': { en: 'Unlock', zh: '瑙ｉ攣' },\r\n    'No entries yet': { en: 'No entries yet...', zh: '鏆傛棤璁板綍...' },\r\n    'No memories yet': { en: 'No memories yet...', zh: '鏆傛棤璁板繂...' },\r\n    'Significance': { en: 'Significance', zh: '閲嶈绋嬪害' },\r\n    'Impact': { en: 'Impact', zh: '褰卞搷' },\r\n\r\n    // Comments & Likes\r\n    'Like': { en: 'Like', zh: '璧? },\r\n    'Unlike': { en: 'Unlike', zh: '鍙栨秷璧? },\r\n    'Comment': { en: 'Comment', zh: '璇勮' },\r\n    'Reply': { en: 'Reply...', zh: '鍥炲...' },\r\n\r\n    // Form Errors\r\n    'Required fields missing': { en: 'Please fill in Name, Persona, API Endpoint, API Key, and Model.', zh: '璇峰～鍐欏悕绉般€佽鑹茶瀹氥€丄PI Endpoint銆丄PI Key 鍜屾ā鍨嬪悕绉般€? },\r\n    'Failed to add character': { en: 'Failed to add character', zh: '娣诲姞瑙掕壊澶辫触' },\r\n    'Failed to clear history': { en: 'Failed to clear history', zh: '娓呴櫎鍘嗗彶璁板綍澶辫触' },\r\n    'History cleared': { en: 'History cleared', zh: '鍘嗗彶璁板綍宸叉竻闄? },\r\n    'Are you sure clear history': { en: 'Are you sure you want to clear this chat history?', zh: '纭畾瑕佹竻闄ゆ鑱婂ぉ璁板綍鍚楋紵' }\r\n};\r\n\r\nexport const LanguageProvider = ({ children }) => {\r\n    const [lang, setLang] = useState(() => {\r\n        return localStorage.getItem('chatpulse_lang') || 'zh';\r\n    });\r\n\r\n    useEffect(() => {\r\n        localStorage.setItem('chatpulse_lang', lang);\r\n    }, [lang]);\r\n\r\n    const toggleLanguage = () => {\r\n        setLang(prev => (prev === 'en' ? 'zh' : 'en'));\r\n    };\r\n\r\n    const t = (key) => {\r\n        if (!translations[key]) return key;\r\n        return translations[key][lang] || key;\r\n    };\r\n\r\n    return (\r\n        <LanguageContext.Provider value={{ lang, toggleLanguage, t }}>\r\n            {children}\r\n        </LanguageContext.Provider>\r\n    );\r\n};\r\n\r\nexport const useLanguage = () => useContext(LanguageContext);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\components\\AddCharacterModal.jsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'lang' is not defined.","line":44,"column":23,"nodeType":"Identifier","messageId":"undef","endLine":44,"endColumn":27},{"ruleId":"no-undef","severity":2,"message":"'lang' is not defined.","line":48,"column":19,"nodeType":"Identifier","messageId":"undef","endLine":48,"endColumn":23},{"ruleId":"no-undef","severity":2,"message":"'lang' is not defined.","line":81,"column":19,"nodeType":"Identifier","messageId":"undef","endLine":81,"endColumn":23}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { X, Wand2, RefreshCw } from 'lucide-react';\r\nimport { useLanguage } from '../LanguageContext';\r\n\r\nfunction AddCharacterModal({ isOpen, onClose, onAdd, apiUrl }) {\r\n    const { t } = useLanguage();\r\n    const [formData, setFormData] = useState({\r\n        id: '',\r\n        name: '',\r\n        avatar: '',\r\n        persona: '',\r\n        api_endpoint: '',\r\n        api_key: '',\r\n        model_name: '',\r\n        affinity: 50\r\n    });\r\n\r\n    const [genQuery, setGenQuery] = useState('');\r\n    const [isGenerating, setIsGenerating] = useState(false);\r\n    const [modelList, setModelList] = useState([]);\r\n    const [fetchingModels, setFetchingModels] = useState(false);\r\n    const [modelFetchError, setModelFetchError] = useState('');\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const handleSubmit = async (e) => {\r\n        e.preventDefault();\r\n\r\n        // Auto-generate ID if missing\r\n        const characterId = formData.id.trim() || `char-${Date.now()}`;\r\n        const payload = { ...formData, id: characterId };\r\n\r\n        try {\r\n            const res = await fetch(`${apiUrl}/characters`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify(payload)\r\n            });\r\n            const data = await res.json();\r\n            if (data.success) {\r\n                onAdd(data.character);\r\n                onClose();\r\n            } else {\r\n                alert(lang === 'en' ? 'Add failed: ' + data.error : '娣诲姞澶辫触: ' + data.error);\r\n            }\r\n        } catch (err) {\r\n            console.error(err);\r\n            alert(lang === 'en' ? 'Failed to connect to backend.' : '鏃犳硶杩炴帴鍒板悗绔湇鍔″櫒銆?);\r\n        }\r\n    };\r\n\r\n    const handleGenerate = async () => {\r\n        if (!genQuery || !formData.api_endpoint || !formData.api_key || !formData.model_name) {\r\n            alert(t('Required fields missing'));\r\n            return;\r\n        }\r\n        setIsGenerating(true);\r\n        try {\r\n            const res = await fetch(`${apiUrl}/characters/generate`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                    query: genQuery,\r\n                    api_endpoint: formData.api_endpoint,\r\n                    api_key: formData.api_key,\r\n                    model_name: formData.model_name\r\n                })\r\n            });\r\n            const data = await res.json();\r\n            if (!res.ok) throw new Error(data.error);\r\n\r\n            // Auto-fill the form with generated data\r\n            setFormData(prev => ({\r\n                ...prev,\r\n                name: data.character.name || prev.name,\r\n                avatar: data.character.avatar || prev.avatar,\r\n                persona: data.character.persona || prev.persona,\r\n                affinity: data.character.affinity ?? prev.affinity\r\n            }));\r\n        } catch (e) {\r\n            alert(lang === 'en' ? 'Generation Failed: ' + e.message : '鐢熸垚瑙掕壊澶辫触: ' + e.message);\r\n        } finally {\r\n            setIsGenerating(false);\r\n        }\r\n    };\r\n\r\n    const handleFetchModels = async () => {\r\n        if (!formData.api_endpoint || !formData.api_key) {\r\n            setModelFetchError('璇峰厛濉啓 API Endpoint 鍜?API Key');\r\n            return;\r\n        }\r\n        setFetchingModels(true);\r\n        setModelFetchError('');\r\n        setModelList([]);\r\n        try {\r\n            const res = await fetch(\r\n                `${apiUrl}/models?endpoint=${encodeURIComponent(formData.api_endpoint)}&key=${encodeURIComponent(formData.api_key)}`\r\n            );\r\n            const data = await res.json();\r\n            if (!res.ok) throw new Error(data.error);\r\n            setModelList(data.models || []);\r\n            if ((data.models || []).length === 0) setModelFetchError('鏈壘鍒板彲鐢ㄦā鍨?);\r\n        } catch (e) {\r\n            setModelFetchError('鎷夊彇澶辫触: ' + e.message);\r\n        }\r\n        setFetchingModels(false);\r\n    };\r\n\r\n    return (\r\n        <div className=\"modal-overlay\" style={{\r\n            position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,\r\n            backgroundColor: 'rgba(0,0,0,0.5)', display: 'flex',\r\n            justifyContent: 'center', alignItems: 'center', zIndex: 1000\r\n        }}>\r\n            <div className=\"modal-content\" style={{\r\n                backgroundColor: '#fff', padding: '20px', borderRadius: '8px',\r\n                width: '500px', maxWidth: '90%', maxHeight: '90vh', overflowY: 'auto'\r\n            }}>\r\n                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '15px' }}>\r\n                    <h3 style={{ margin: 0, fontSize: '18px' }}>Add New Contact</h3>\r\n                    <button onClick={onClose} style={{ background: 'none', border: 'none', cursor: 'pointer' }}><X size={20} /></button>\r\n                </div>\r\n\r\n                {/* AI Generator Box */}\r\n                <div style={{ padding: '15px', backgroundColor: '#f9f9f9', border: '1px solid #ddd', borderRadius: '6px', marginBottom: '20px' }}>\r\n                    <div style={{ display: 'flex', alignItems: 'center', gap: '5px', marginBottom: '10px', color: '#333', fontWeight: 'bold' }}>\r\n                        <Wand2 size={16} color=\"#7B9FE0\" /> Auto-Generate Character\r\n                    </div>\r\n                    <textarea\r\n                        value={genQuery}\r\n                        onChange={(e) => setGenQuery(e.target.value)}\r\n                        placeholder=\"Describe the persona... (Make sure to fill out API keys below first)\"\r\n                        style={{ width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px', boxSizing: 'border-box', minHeight: '60px', resize: 'vertical' }}\r\n                    />\r\n                    <button\r\n                        type=\"button\"\r\n                        onClick={handleGenerate}\r\n                        disabled={isGenerating}\r\n                        style={{ marginTop: '10px', width: '100%', padding: '8px', backgroundColor: isGenerating ? '#ccc' : '#7B9FE0', color: '#fff', border: 'none', borderRadius: '4px', cursor: isGenerating ? 'not-allowed' : 'pointer' }}\r\n                    >\r\n                        {isGenerating ? '鉁?Generating...' : 'Auto-Fill Form'}\r\n                    </button>\r\n                </div>\r\n\r\n                <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>\r\n                    <div>\r\n                        <label style={{ display: 'block', marginBottom: '5px', fontSize: '14px', fontWeight: 'bold' }}>{t('Name')} (Required)</label>\r\n                        <input type=\"text\" required value={formData.name} onChange={e => setFormData({ ...formData, name: e.target.value })}\r\n                            style={{ width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px', boxSizing: 'border-box' }} />\r\n                    </div>\r\n                    <div>\r\n                        <label style={{ display: 'block', marginBottom: '5px', fontSize: '14px', fontWeight: 'bold' }}>{t('Avatar URL')}</label>\r\n                        <input type=\"text\" value={formData.avatar} onChange={e => setFormData({ ...formData, avatar: e.target.value })}\r\n                            placeholder=\"https://...\"\r\n                            style={{ width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px', boxSizing: 'border-box' }} />\r\n                    </div>\r\n                    <div>\r\n                        <label style={{ display: 'block', marginBottom: '5px', fontSize: '14px', fontWeight: 'bold' }}>{t('Persona')}</label>\r\n                        <textarea value={formData.persona} onChange={e => setFormData({ ...formData, persona: e.target.value })}\r\n                            rows={4}\r\n                            style={{ width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px', boxSizing: 'border-box', fontFamily: 'inherit' }} />\r\n                    </div>\r\n                    <div>\r\n                        <label style={{ display: 'block', marginBottom: '5px', fontSize: '14px', fontWeight: 'bold' }}>Initial Affinity (0-100)</label>\r\n                        <input type=\"number\" min=\"0\" max=\"100\" value={formData.affinity} onChange={e => setFormData({ ...formData, affinity: parseInt(e.target.value) || 0 })}\r\n                            style={{ width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px', boxSizing: 'border-box' }} />\r\n                    </div>\r\n\r\n                    <hr style={{ borderTop: '1px dashed #ddd', margin: '5px 0' }} />\r\n\r\n                    <div>\r\n                        <label style={{ display: 'block', marginBottom: '5px', fontSize: '14px', fontWeight: 'bold', color: '#666' }}>{t('API Endpoint')}</label>\r\n                        <input type=\"text\" value={formData.api_endpoint} onChange={e => setFormData({ ...formData, api_endpoint: e.target.value })}\r\n                            placeholder=\"https://api.openai.com/v1/chat/completions\"\r\n                            style={{ width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px', boxSizing: 'border-box' }} />\r\n                    </div>\r\n                    <div>\r\n                        <label style={{ display: 'block', marginBottom: '5px', fontSize: '14px', fontWeight: 'bold' }}>{t('API Key')}</label>\r\n                        <input type=\"password\" value={formData.api_key} onChange={e => setFormData({ ...formData, api_key: e.target.value })}\r\n                            style={{ width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px', boxSizing: 'border-box' }} />\r\n                    </div>\r\n                    <div>\r\n                        <label style={{ display: 'block', marginBottom: '5px', fontSize: '14px', fontWeight: 'bold' }}>{t('Model Name')}</label>\r\n                        <div style={{ display: 'flex', gap: '6px' }}>\r\n                            <input type=\"text\" value={formData.model_name} onChange={e => setFormData({ ...formData, model_name: e.target.value })}\r\n                                placeholder=\"gpt-4o\"\r\n                                style={{ flex: 1, padding: '8px', border: '1px solid #ccc', borderRadius: '4px', boxSizing: 'border-box' }} />\r\n                            <button type=\"button\" onClick={handleFetchModels} disabled={fetchingModels}\r\n                                style={{ padding: '8px 12px', background: '#7B9FE0', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', whiteSpace: 'nowrap', display: 'flex', alignItems: 'center', gap: '4px' }}>\r\n                                <RefreshCw size={14} className={fetchingModels ? 'spin' : ''} />\r\n                                {fetchingModels ? '...' : t('Fetch Models')}\r\n                            </button>\r\n                        </div>\r\n                        {modelFetchError && <p style={{ color: '#F06B8E', fontSize: '12px', marginTop: '4px' }}>{modelFetchError}</p>}\r\n                        {modelList.length > 0 && (\r\n                            <select\r\n                                onChange={e => setFormData({ ...formData, model_name: e.target.value })}\r\n                                defaultValue=\"\"\r\n                                style={{ marginTop: '6px', width: '100%', padding: '7px', border: '1px solid #ccc', borderRadius: '4px', fontSize: '13px' }}\r\n                            >\r\n                                <option value=\"\" disabled>鈹€鈹€ 閫夋嫨妯″瀷 鈹€鈹€</option>\r\n                                {modelList.map(m => <option key={m} value={m}>{m}</option>)}\r\n                            </select>\r\n                        )}\r\n                    </div>\r\n\r\n                    <button type=\"submit\" style={{\r\n                        marginTop: '10px', padding: '10px', backgroundColor: '#7B9FE0',\r\n                        color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontWeight: 'bold'\r\n                    }}>{t('Add Character')}</button>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default AddCharacterModal;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\components\\ChatSettingsDrawer.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\components\\ChatWindow.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'topRef' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":44,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":17,"suggestions":[{"messageId":"removeVar","data":{"varName":"topRef"},"fix":{"range":[1956,1984],"text":""},"desc":"Remove unused variable 'topRef'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'contact?.name'. Either include it or remove the dependency array. If 'setMessages' needs the current value of 'contact.name', you can also switch to useReducer instead of useState and read 'contact.name' in the reducer.","line":109,"column":8,"nodeType":"ArrayExpression","endLine":109,"endColumn":34,"suggestions":[{"desc":"Update the dependencies array to be: [engineState, contact?.id, contact?.name]","fix":{"range":[4581,4607],"text":"[engineState, contact?.id, contact?.name]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport MessageBubble from './MessageBubble';\r\nimport InputBar from './InputBar';\r\nimport TransferModal from './TransferModal';\r\nimport RecommendModal from './RecommendModal';\r\nimport { MoreHorizontal, Brain, BookOpen, EyeOff, Eye, UserPlus } from 'lucide-react';\r\nimport { useLanguage } from '../LanguageContext';\r\n\r\n// Parse /hide 0-xx, /hide xx, /unhide commands\r\nfunction parseHideCommand(text) {\r\n    const hideRangeMatch = text.match(/^\\/hide\\s+(\\d+)\\s*[-~]\\s*(\\d+)\\s*$/i);\r\n    if (hideRangeMatch) return { cmd: 'hide', start: parseInt(hideRangeMatch[1]), end: parseInt(hideRangeMatch[2]) };\r\n\r\n    const hideSingleMatch = text.match(/^\\/hide\\s+(\\d+)\\s*$/i);\r\n    if (hideSingleMatch) return { cmd: 'hide', start: 0, end: parseInt(hideSingleMatch[1]) };\r\n\r\n    const unhideMatch = text.match(/^\\/unhide\\s*$/i);\r\n    if (unhideMatch) return { cmd: 'unhide' };\r\n\r\n    return null;\r\n}\r\n\r\nfunction SystemMessage({ text }) {\r\n    return (\r\n        <div style={{ textAlign: 'center', margin: '8px 0' }}>\r\n            <span style={{ fontSize: '12px', color: '#aaa', backgroundColor: '#f0f0f0', padding: '3px 10px', borderRadius: '10px' }}>\r\n                {text}\r\n            </span>\r\n        </div>\r\n    );\r\n}\r\n\r\nfunction ChatWindow({ contact, allContacts, apiUrl, newIncomingMessage, engineState, onToggleMemo, onToggleDiary, onToggleSettings, userAvatar }) {\r\n    const { t, lang } = useLanguage();\r\n    const [messages, setMessages] = useState([]);\r\n    const [isTransferModalOpen, setIsTransferModalOpen] = useState(false);\r\n    const [isRecommendModalOpen, setIsRecommendModalOpen] = useState(false);\r\n    const [hasMore, setHasMore] = useState(false);\r\n    const [loadingMore, setLoadingMore] = useState(false);\r\n    const [showHidden, setShowHidden] = useState(false);\r\n    const PAGE_SIZE = 100;\r\n    const prevBlockedRef = useRef(false);\r\n    const messagesEndRef = useRef(null);\r\n    const topRef = useRef(null);\r\n    // contactRef keeps the current contact ID stable inside async callbacks\r\n    const contactRef = useRef(contact);\r\n    useEffect(() => { contactRef.current = contact; }, [contact]);\r\n\r\n    const isCurrentlyBlocked = engineState?.[contact?.id]?.isBlocked === 1;\r\n\r\n    // Fetch most recent messages when contact changes\r\n    useEffect(() => {\r\n        if (!contact?.id) return;\r\n        setMessages([]);\r\n        setHasMore(false);\r\n        fetch(`${apiUrl}/messages/${contact.id}?limit=${PAGE_SIZE}`)\r\n            .then(res => res.json())\r\n            .then(data => {\r\n                setMessages(data);\r\n                // If we got a full page, there are probably more older messages\r\n                setHasMore(data.length >= PAGE_SIZE);\r\n            })\r\n            .catch(err => console.error('Failed to load messages:', err));\r\n    }, [contact?.id, apiUrl]);\r\n\r\n    const loadMore = async () => {\r\n        if (loadingMore || messages.length === 0) return;\r\n        setLoadingMore(true);\r\n        const oldest = messages[0];\r\n        try {\r\n            const data = await fetch(\r\n                `${apiUrl}/messages/${contactRef.current?.id}?limit=${PAGE_SIZE}&before=${oldest.id}`\r\n            ).then(r => r.json());\r\n            if (data.length > 0) {\r\n                setMessages(prev => [...data, ...prev]);\r\n                setHasMore(data.length >= PAGE_SIZE);\r\n            } else {\r\n                setHasMore(false);\r\n            }\r\n        } catch (e) {\r\n            console.error('Failed to load more:', e);\r\n        }\r\n        setLoadingMore(false);\r\n    };\r\n\r\n    // Handle new incoming WS messages\r\n    useEffect(() => {\r\n        if (newIncomingMessage && contact?.id && newIncomingMessage.character_id === contact.id) {\r\n            setMessages(prev => {\r\n                if (prev.some(m => m.id === newIncomingMessage.id)) return prev;\r\n                return [...prev, newIncomingMessage];\r\n            });\r\n        }\r\n    }, [newIncomingMessage, contact?.id]);\r\n\r\n    // Detect when a character goes from unblocked -> blocked mid-session and inject a system message\r\n    useEffect(() => {\r\n        const isBlocked = engineState?.[contact?.id]?.isBlocked === 1;\r\n        if (isBlocked && !prevBlockedRef.current) {\r\n            setMessages(prev => [...prev, {\r\n                id: `block-event-${Date.now()}`,\r\n                character_id: contact?.id,\r\n                role: 'system',\r\n                content: `[System] ${contact?.name} 灏嗕綘鎷夐粦浜嗐€俙,\r\n                timestamp: Date.now()\r\n            }]);\r\n        }\r\n        prevBlockedRef.current = isBlocked;\r\n    }, [engineState, contact?.id]);\r\n\r\n    useEffect(() => {\r\n        if (messagesEndRef.current) {\r\n            messagesEndRef.current.scrollIntoView({ behavior: 'smooth', block: 'end' });\r\n        }\r\n    }, [messages]);\r\n\r\n    const handleSend = async (text) => {\r\n        const currentContactId = contactRef.current?.id;\r\n        if (!currentContactId) return;\r\n\r\n        // Check for /hide or /unhide slash commands\r\n        const hideCmd = parseHideCommand(text.trim());\r\n        if (hideCmd) {\r\n            if (hideCmd.cmd === 'hide') {\r\n                const res = await fetch(`${apiUrl}/messages/${currentContactId}/hide`, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({ startIdx: hideCmd.start, endIdx: hideCmd.end })\r\n                });\r\n                const data = await res.json();\r\n                if (data.success && contactRef.current?.id === currentContactId) {\r\n                    const updated = await fetch(`${apiUrl}/messages/${currentContactId}`).then(r => r.json());\r\n                    setMessages(updated);\r\n                }\r\n            } else if (hideCmd.cmd === 'unhide') {\r\n                const res = await fetch(`${apiUrl}/messages/${currentContactId}/unhide`, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' }\r\n                });\r\n                const data = await res.json();\r\n                if (data.success && contactRef.current?.id === currentContactId) {\r\n                    const updated = await fetch(`${apiUrl}/messages/${currentContactId}`).then(r => r.json());\r\n                    setMessages(updated);\r\n                }\r\n            }\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const res = await fetch(`${apiUrl}/messages`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ characterId: currentContactId, content: text })\r\n            });\r\n            const data = await res.json();\r\n            // Only update state if we're still looking at the same contact\r\n            if (contactRef.current?.id !== currentContactId) return;\r\n            if (data.blocked && data.message) {\r\n                setMessages(prev => [...prev, { ...data.message, isBlocked: true }]);\r\n            }\r\n        } catch (e) {\r\n            console.error('Failed to send:', e);\r\n        }\r\n    };\r\n\r\n    const handleTransfer = async (amount, note) => {\r\n        const currentContactId = contactRef.current?.id;\r\n        setIsTransferModalOpen(false);\r\n        try {\r\n            const res = await fetch(`${apiUrl}/characters/${currentContactId}/transfer`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ amount, note })\r\n            });\r\n            const data = await res.json();\r\n            if (data.success && contactRef.current?.id === currentContactId) {\r\n                // Refresh messages to pick up the new transfer message with tid\r\n                const updated = await fetch(`${apiUrl}/messages/${currentContactId}`).then(r => r.json());\r\n                setMessages(updated);\r\n            }\r\n        } catch (e) {\r\n            console.error('Transfer failed:', e);\r\n        }\r\n    };\r\n\r\n    const handleRecommendContact = async (targetCharId) => {\r\n        setIsRecommendModalOpen(false);\r\n        try {\r\n            const res = await fetch(`${apiUrl}/characters/${contactRef.current?.id}/friends`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ target_id: targetCharId })\r\n            });\r\n            const data = await res.json();\r\n            if (data.success) {\r\n                const updated = await fetch(`${apiUrl}/messages/${contactRef.current?.id}`).then(r => r.json());\r\n                setMessages(updated);\r\n            } else {\r\n                alert(lang === 'en' ? 'Failed to recommend contact: ' + data.error : '鎺ㄨ崘鑱旂郴浜哄け璐? ' + data.error);\r\n            }\r\n        } catch (e) {\r\n            console.error('Failed to recommend contact:', e);\r\n            alert(lang === 'en' ? 'Network error.' : '缃戠粶閿欒銆?);\r\n        }\r\n    };\r\n\r\n    if (!contact) return null;\r\n\r\n    const hiddenCount = messages.filter(m => m.hidden).length;\r\n    // Always show all messages to the user. Hidden = dimmed (AI won't see them).\r\n    // showHidden controls whether the dim effect + badge are visible or not.\r\n\r\n    return (\r\n        <>\r\n            <div className=\"chat-header\">\r\n                <div className=\"chat-header-title\" style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>\r\n                    {contact.name}\r\n                    {engineState?.[contact.id]?.isBlocked === 1 && <span style={{ color: '#F06B8E', fontSize: '14px', fontWeight: 'bold' }}>(Blocked) 馃毇</span>}\r\n                </div>\r\n                <div className=\"chat-header-actions\">\r\n                    <button onClick={() => setIsRecommendModalOpen(true)} title={lang === 'en' ? 'Recommend Contact' : '鎺ㄨ崘鑱旂郴浜?}>\r\n                        <UserPlus size={20} />\r\n                    </button>\r\n                    <button onClick={onToggleMemo} title={t('Memories')}>\r\n                        <Brain size={20} />\r\n                    </button>\r\n                    <button onClick={onToggleDiary} title={t('Secret Diary')}>\r\n                        <BookOpen size={20} />\r\n                    </button>\r\n                    <button onClick={onToggleSettings} title={t('Chat Settings')}>\r\n                        <MoreHorizontal size={20} />\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {hiddenCount > 0 && (\r\n                <div\r\n                    style={{ display: 'flex', justifyContent: 'center', padding: '5px', background: '#fff9e0', cursor: 'pointer', fontSize: '12px', color: '#888', gap: '5px', alignItems: 'center', borderBottom: '1px solid #f0e8c0' }}\r\n                    onClick={() => setShowHidden(h => !h)}\r\n                >\r\n                    {showHidden ? <Eye size={13} /> : <EyeOff size={13} />}\r\n                    {hiddenCount} messages hidden from AI context (shown dimmed) 鈥?click to {showHidden ? 'show badges' : 'hide badges'}\r\n                </div>\r\n            )}\r\n\r\n            {isCurrentlyBlocked && (\r\n                <div style={{ textAlign: 'center', padding: '8px', background: '#ffebeb', color: '#F06B8E', fontSize: '14px', fontWeight: 'bold', borderBottom: '1px solid #ffcccc' }}>\r\n                    You are blocked by {contact.name}. You cannot send messages.\r\n                </div>\r\n            )}\r\n\r\n            <div className=\"chat-history\">\r\n                {hasMore && (\r\n                    <div style={{ textAlign: 'center', padding: '10px' }}>\r\n                        <button\r\n                            onClick={loadMore}\r\n                            disabled={loadingMore}\r\n                            style={{\r\n                                fontSize: '12px', color: '#888', background: '#f5f5f5',\r\n                                border: '1px solid #ddd', borderRadius: '12px',\r\n                                padding: '5px 16px', cursor: 'pointer'\r\n                            }}\r\n                        >\r\n                            {loadingMore ? t('Loading') : (lang === 'en' ? '鈫?Load older messages' : '鈫?鍔犺浇鏇存棭鐨勬秷鎭?)}\r\n                        </button>\r\n                    </div>\r\n                )}\r\n                {messages.map((msg, idx) => {\r\n                    if (idx > 0 && messages[idx - 1].id === msg.id) return null;\r\n                    return (\r\n                        <div key={msg.id} style={msg.hidden ? {\r\n                            opacity: 0.4, filter: 'grayscale(0.5)',\r\n                            borderLeft: '3px solid #f0c060', paddingLeft: '4px',\r\n                            marginBottom: '2px'\r\n                        } : {}}>\r\n                            <MessageBubble\r\n                                message={msg}\r\n                                characterName={contact.name}\r\n                                avatar={msg.role === 'character' ? contact.avatar : (userAvatar || 'https://api.dicebear.com/7.x/notionists/svg?seed=User')}\r\n                                apiUrl={apiUrl}\r\n                            />\r\n                        </div>\r\n                    );\r\n                })}\r\n                {engineState?.[contact.id]?.countdownMs > 0 && engineState?.[contact.id]?.isBlocked !== 1 && (\r\n                    <div className=\"message-wrapper character\" style={{ marginTop: '10px' }}>\r\n                        <div className=\"message-avatar\" style={{ visibility: 'hidden' }}>\r\n                            <img src={contact.avatar} alt=\"Avatar\" />\r\n                        </div>\r\n                        <div className=\"message-content\">\r\n                            <div className=\"message-bubble\" style={{ background: 'transparent', color: '#bbb', boxShadow: 'none', fontStyle: 'italic', padding: 0 }}>\r\n                                {t('Thinking')} 鈴?{Math.ceil(engineState[contact.id].countdownMs / 1000)}s\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n                <div ref={messagesEndRef} />\r\n            </div>\r\n\r\n            <InputBar\r\n                onSend={handleSend}\r\n                onTransfer={() => setIsTransferModalOpen(true)}\r\n                onQuickHide={async () => {\r\n                    const cid = contactRef.current?.id;\r\n                    if (!cid) return;\r\n                    const all = messages;\r\n                    const half = Math.floor(all.length / 2);\r\n                    if (half === 0) return;\r\n                    const res = await fetch(`${apiUrl}/messages/${cid}/hide`, {\r\n                        method: 'POST',\r\n                        headers: { 'Content-Type': 'application/json' },\r\n                        body: JSON.stringify({ startIdx: 0, endIdx: half - 1 })\r\n                    });\r\n                    if ((await res.json()).success && contactRef.current?.id === cid) {\r\n                        const updated = await fetch(`${apiUrl}/messages/${cid}`).then(r => r.json());\r\n                        setMessages(updated);\r\n                    }\r\n                }}\r\n            />\r\n            {isTransferModalOpen && (\r\n                <TransferModal\r\n                    contact={contact}\r\n                    onClose={() => setIsTransferModalOpen(false)}\r\n                    onConfirm={handleTransfer}\r\n                />\r\n            )}\r\n            {isRecommendModalOpen && (\r\n                <RecommendModal\r\n                    apiUrl={apiUrl}\r\n                    currentContact={contact}\r\n                    allContacts={allContacts || []}\r\n                    onClose={() => setIsRecommendModalOpen(false)}\r\n                    onRecommend={handleRecommendContact}\r\n                />\r\n            )}\r\n        </>\r\n    );\r\n}\r\n\r\nexport default ChatWindow;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\components\\ContactList.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'pressure' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":8,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"pressure"},"fix":{"range":[246,284],"text":""},"desc":"Remove unused variable 'pressure'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\n\r\nfunction ContactList({ contacts, activeId, onSelect, engineState = {} }) {\r\n    return (\r\n        <>\r\n            {contacts.map((contact) => {\r\n                const state = engineState[contact.id];\r\n                const pressure = state?.pressure || 0;\r\n                const countdown = state?.countdownMs ? Math.ceil(state.countdownMs / 1000) : null;\r\n\r\n                return (\r\n                    <div\r\n                        key={contact.id}\r\n                        className={`contact-item ${activeId === contact.id ? 'active' : ''}`}\r\n                        onClick={() => onSelect(contact.id)}\r\n                    >\r\n                        <div className=\"contact-avatar\" style={{ position: 'relative' }}>\r\n                            <img src={contact.avatar} alt={contact.name} />\r\n                            <div className={`autopulse-status-dot ${state?.isThinking ? 'thinking' : 'connected'}`} />\r\n                        </div>\r\n                        <div className=\"contact-info\">\r\n                            <div className=\"contact-header\">\r\n                                <span className=\"contact-name\">{contact.name}</span>\r\n                                <span className=\"contact-time\" style={{ color: countdown ? (state?.isThinking ? '#ff9800' : '#7B9FE0') : undefined, fontWeight: countdown ? 'bold' : 'normal' }}>\r\n                                    {countdown ? (state?.isThinking ? '鉁嶏笍...' : `鈴?${countdown}s`) : contact.time}\r\n                                </span>\r\n                            </div>\r\n                            <div className=\"contact-last-msg\">\r\n                                {contact.lastMessage}\r\n                                {contact.unread > 0 && <span className=\"unread-badge\">{contact.unread}</span>}\r\n                                {state?.isBlocked === 1 && <span style={{ marginLeft: 5, color: '#F06B8E' }} title=\"Blocked\">馃毇</span>}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                )\r\n            })}\r\n        </>\r\n    );\r\n}\r\n\r\nexport default ContactList;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\components\\CreateGroupModal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\components\\DiaryTable.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'contact'. Either include it or remove the dependency array.","line":32,"column":8,"nodeType":"ArrayExpression","endLine":32,"endColumn":29,"suggestions":[{"desc":"Update the dependencies array to be: [apiUrl, contact, contact.id]","fix":{"range":[1284,1305],"text":"[apiUrl, contact, contact.id]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":52,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":52,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { BookOpen, X, Lock, KeyRound, Eye } from 'lucide-react';\r\nimport { useLanguage } from '../LanguageContext';\r\n\r\nfunction DiaryTable({ contact, apiUrl, onClose }) {\r\n    const { t, lang } = useLanguage();\r\n    const [diaries, setDiaries] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [isUnlocked, setIsUnlocked] = useState(false);\r\n    const [passwordInput, setPasswordInput] = useState('');\r\n    const [pwError, setPwError] = useState('');\r\n    const [pwLoading, setPwLoading] = useState(false);\r\n\r\n    useEffect(() => {\r\n        if (!contact) return;\r\n        fetch(`${apiUrl}/diaries/${contact.id}`)\r\n            .then(res => res.json())\r\n            .then(data => {\r\n                if (data.entries !== undefined) {\r\n                    setDiaries(data.entries);\r\n                    setIsUnlocked(data.isUnlocked);\r\n                } else {\r\n                    setDiaries(data);\r\n                    setIsUnlocked(data.length > 0 && data[0].is_unlocked === 1);\r\n                }\r\n                setLoading(false);\r\n            })\r\n            .catch(err => {\r\n                console.error('Failed to load diaries:', err);\r\n                setLoading(false);\r\n            });\r\n    }, [apiUrl, contact?.id]);\r\n\r\n    const handlePasswordSubmit = async (e) => {\r\n        e.preventDefault();\r\n        if (!passwordInput.trim()) return;\r\n        setPwLoading(true);\r\n        setPwError('');\r\n        try {\r\n            const res = await fetch(`${apiUrl}/diaries/${contact.id}/unlock`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ password: passwordInput.trim() })\r\n            });\r\n            const data = await res.json();\r\n            if (data.success) {\r\n                setIsUnlocked(true);\r\n                setDiaries(prev => prev.map(d => ({ ...d, is_unlocked: 1 })));\r\n            } else {\r\n                setPwError(data.reason || 'Wrong password.');\r\n            }\r\n        } catch (e) {\r\n            setPwError('Network error. Try again.');\r\n        }\r\n        setPwLoading(false);\r\n    };\r\n\r\n    return (\r\n        <div className=\"memory-drawer\" style={{ width: '380px', backgroundColor: '#fffdf5' }}>\r\n            <div className=\"memory-header\" style={{ backgroundColor: '#f6f1e3', borderBottomColor: '#e0d8c3' }}>\r\n                <h3 style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#5a4d3c' }}>\r\n                    <BookOpen size={18} />\r\n                    {contact.name} {lang === 'en' ? \"'s Diary\" : \"鐨勬棩璁癨"}\r\n                </h3>\r\n                <button className=\"icon-btn\" onClick={onClose}>\r\n                    <X size={20} />\r\n                </button>\r\n            </div>\r\n\r\n            <div className=\"memory-list\" style={{ padding: '20px' }}>\r\n                {loading ? (\r\n                    <div className=\"placeholder-text\">{t('Loading')}</div>\r\n                ) : !isUnlocked ? (\r\n                    <div style={{ textAlign: 'center', marginTop: '30px' }}>\r\n                        <Lock size={48} color=\"#d4a96a\" style={{ marginBottom: '12px' }} />\r\n                        <div style={{ color: '#5a4d3c', fontWeight: 'bold', fontSize: '16px', marginBottom: '6px' }}>\r\n                            {t('Diary Locked')}\r\n                        </div>\r\n                        <div style={{ fontSize: '12px', color: '#aaa', marginBottom: '24px', padding: '0 20px' }}>\r\n                            {lang === 'en' ? `Build your bond with ${contact.name} and get them to reveal their password.` : `涓?${contact.name} 鍩瑰吇浜插瘑搴︼紝骞惰瘯鐫€璁╁鏂瑰憡璇変綘瀵嗙爜鍚с€俙}\r\n                        </div>\r\n\r\n                        <form onSubmit={handlePasswordSubmit} style={{ display: 'flex', flexDirection: 'column', gap: '10px', alignItems: 'center' }}>\r\n                            <div style={{ position: 'relative', width: '100%', maxWidth: '240px' }}>\r\n                                <KeyRound size={15} style={{ position: 'absolute', left: '10px', top: '50%', transform: 'translateY(-50%)', color: '#bbb' }} />\r\n                                <input\r\n                                    type=\"text\"\r\n                                    value={passwordInput}\r\n                                    onChange={e => { setPasswordInput(e.target.value); setPwError(''); }}\r\n                                    placeholder={lang === 'en' ? \"Enter diary password...\" : \"杈撳叆鏃ヨ瀵嗙爜...\"}\r\n                                    style={{\r\n                                        width: '100%', boxSizing: 'border-box',\r\n                                        padding: '9px 12px 9px 32px', borderRadius: '8px',\r\n                                        border: pwError ? '1.5px solid #F06B8E' : '1.5px solid #e0d8c3',\r\n                                        background: '#fff', fontSize: '14px', outline: 'none',\r\n                                        color: '#333', letterSpacing: '1px'\r\n                                    }}\r\n                                />\r\n                            </div>\r\n                            {pwError && (\r\n                                <div style={{ color: '#F06B8E', fontSize: '12px' }}>{pwError}</div>\r\n                            )}\r\n                            <button\r\n                                type=\"submit\"\r\n                                disabled={pwLoading || !passwordInput.trim()}\r\n                                style={{\r\n                                    padding: '8px 24px', borderRadius: '8px', border: 'none',\r\n                                    background: '#d4a96a', color: '#fff', fontWeight: '600',\r\n                                    fontSize: '14px', cursor: 'pointer', opacity: pwLoading ? 0.6 : 1\r\n                                }}\r\n                            >\r\n                                {pwLoading ? (lang === 'en' ? 'Checking...' : '楠岃瘉涓?..') : t('Unlock Diary')}\r\n                            </button>\r\n                        </form>\r\n\r\n                        <div style={{ marginTop: '20px', fontSize: '11px', color: '#ccc', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '5px' }}>\r\n                            <Eye size={11} /> {lang === 'en' ? `Hint: Ask ${contact.name} directly in chat.` : `鎻愮ず锛氳瘯鐫€鍦ㄨ亰澶╀腑鐩存帴璇㈤棶 ${contact.name}銆俙}\r\n                        </div>\r\n                    </div>\r\n                ) : diaries.length === 0 ? (\r\n                    <div className=\"empty-text\">{t('No entries yet')}</div>\r\n                ) : (\r\n                    diaries.map(diary => {\r\n                        const dateObj = new Date(diary.timestamp);\r\n                        const dateStr = dateObj.toLocaleDateString();\r\n                        const timeStr = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n\r\n                        return (\r\n                            <div key={diary.id} className=\"diary-entry\" style={{\r\n                                backgroundColor: '#fff', border: '1px solid #eee', borderRadius: '8px',\r\n                                padding: '15px', marginBottom: '15px', boxShadow: '0 2px 5px rgba(0,0,0,0.02)'\r\n                            }}>\r\n                                <div className=\"diary-meta\" style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px', color: '#999', fontSize: '13px' }}>\r\n                                    <span>{dateStr} {timeStr}</span>\r\n                                    {diary.emotion && <span style={{ textTransform: 'capitalize' }}>{diary.emotion}</span>}\r\n                                </div>\r\n                                <div className=\"diary-content\" style={{ color: '#333', lineHeight: '1.6', fontSize: '15px', whiteSpace: 'pre-wrap' }}>\r\n                                    {diary.content}\r\n                                </div>\r\n                            </div>\r\n                        );\r\n                    })\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default DiaryTable;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\components\\GroupChatWindow.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadPkt'. Either include it or remove the dependency array.","line":95,"column":51,"nodeType":"ArrayExpression","endLine":95,"endColumn":61,"suggestions":[{"desc":"Update the dependencies array to be: [loadPkt, packetId]","fix":{"range":[7055,7065],"text":"[loadPkt, packetId]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'allContacts' is defined but never used.","line":153,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":153,"endColumn":56,"suggestions":[{"messageId":"removeVar","data":{"varName":"allContacts"},"fix":{"range":[10786,10799],"text":""},"desc":"Remove unused variable 'allContacts'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'togglePause' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":163,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":163,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"togglePause"},"fix":{"range":[11287,11537],"text":""},"desc":"Remove unused variable 'togglePause'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport { Send, Users, Smile, Paperclip, X, Settings, Trash2, UserMinus, ArrowRightLeft, Gift } from 'lucide-react';\r\nimport { useLanguage } from '../LanguageContext';\r\n\r\nconst quickEmojis = ['馃榾', '馃槀', '馃ズ', '馃槨', '馃グ', '馃憤', '馃檹', '馃挃', '馃敟', '鉁?, '馃コ', '馃槶', '馃槑', '馃檮', '馃'];\r\n\r\n/* 鈹€鈹€鈹€ Red Packet Send Modal 鈹€鈹€鈹€ */\r\nfunction RedPacketModal({ group, apiUrl, onClose, userWallet }) {\r\n    const { lang } = useLanguage();\r\n    const [type, setType] = useState('lucky');\r\n    const [amount, setAmount] = useState('');\r\n    const [count, setCount] = useState(group?.members?.length || 3);\r\n    const [note, setNote] = useState('');\r\n    const isFixed = type === 'fixed';\r\n    const cnt = Math.max(1, parseInt(count) || 1);\r\n    const amt = Math.max(0, parseFloat(amount) || 0);\r\n    const totalCost = isFixed ? amt * cnt : amt;\r\n    const overBudget = totalCost > (userWallet ?? 100);\r\n    const isValid = amt > 0 && cnt > 0 && !overBudget;\r\n\r\n    const onSend = async () => {\r\n        if (!isValid) return;\r\n        try {\r\n            await fetch(`${apiUrl}/groups/${group.id}/redpackets`, {\r\n                method: 'POST', headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ type, count: cnt, amount: amt, note: note.trim(), totalCost })\r\n            });\r\n            onClose();\r\n        } catch (e) { console.error(e); }\r\n    };\r\n\r\n    return (\r\n        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>\r\n            <div style={{ width: '340px', borderRadius: '14px', overflow: 'hidden', boxShadow: '0 10px 40px rgba(0,0,0,0.3)', background: '#fff' }}>\r\n                <div style={{ background: 'linear-gradient(135deg,#d63031,#c0392b)', padding: '18px 20px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                    <span style={{ color: '#fff', fontWeight: '700', fontSize: '17px' }}>馃Ё {lang === 'en' ? 'Send Red Packet' : '鍙戦€佺孩鍖?}</span>\r\n                    <button onClick={onClose} style={{ background: 'none', border: 'none', color: '#ffcccb', cursor: 'pointer', fontSize: '20px', lineHeight: 1 }}>脳</button>\r\n                </div>\r\n                <div style={{ display: 'flex', borderBottom: '1px solid #f0f0f0' }}>\r\n                    {[['lucky', lang === 'en' ? '馃幉 Lucky' : '馃幉 鎷兼墜姘?], ['fixed', lang === 'en' ? '馃摝 Regular' : '馃摝 鏅€?]].map(([t, label]) => (\r\n                        <button key={t} onClick={() => setType(t)}\r\n                            style={{\r\n                                flex: 1, padding: '10px', border: 'none', cursor: 'pointer', fontWeight: type === t ? '700' : '400',\r\n                                background: type === t ? '#fff5f5' : '#fff', color: type === t ? '#c0392b' : '#666', borderBottom: type === t ? '2px solid #c0392b' : '2px solid transparent'\r\n                            }}>\r\n                            {label}\r\n                        </button>\r\n                    ))}\r\n                </div>\r\n                <div style={{ padding: '16px 20px' }}>\r\n                    <div style={{ marginBottom: '14px' }}>\r\n                        <label style={{ fontSize: '12px', color: '#999', display: 'block', marginBottom: '5px' }}>{lang === 'en' ? 'Number of packets' : '绾㈠寘涓暟'}</label>\r\n                        <input type=\"number\" min=\"1\" value={count} onChange={e => setCount(e.target.value)} style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #eee', fontSize: '16px', boxSizing: 'border-box' }} />\r\n                    </div>\r\n                    <div style={{ marginBottom: '14px' }}>\r\n                        <label style={{ fontSize: '12px', color: '#999', display: 'block', marginBottom: '5px' }}>\r\n                            {isFixed ? (lang === 'en' ? 'Amount per person (楼)' : '姣忎汉閲戦锛堝厓锛?) : (lang === 'en' ? 'Total amount (楼)' : '鎬婚噾棰濓紙鍏冿級')}\r\n                        </label>\r\n                        <input type=\"number\" min=\"0.01\" step=\"0.01\" placeholder=\"楼\" value={amount} onChange={e => setAmount(e.target.value)} style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #eee', fontSize: '16px', boxSizing: 'border-box' }} />\r\n                    </div>\r\n                    <div style={{ marginBottom: '16px' }}>\r\n                        <label style={{ fontSize: '12px', color: '#999', display: 'block', marginBottom: '5px' }}>{lang === 'en' ? 'Message (optional)' : '鐣欒█锛堝彲閫夛級'}</label>\r\n                        <input type=\"text\" placeholder={lang === 'en' ? 'Leave a message...' : '鍐欑偣浠€涔?..'} value={note} onChange={e => setNote(e.target.value)} style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #eee', fontSize: '14px', boxSizing: 'border-box' }} />\r\n                    </div>\r\n                    <div style={{ background: '#fafafa', borderRadius: '8px', padding: '10px 12px', marginBottom: '16px', fontSize: '13px' }}>\r\n                        <div style={{ display: 'flex', justifyContent: 'space-between', color: '#555' }}>\r\n                            <span>{lang === 'en' ? 'Total cost:' : '鍚堣锛?}</span>\r\n                            <span style={{ fontWeight: '600', color: totalCost > 0 ? '#c0392b' : '#aaa' }}>楼{totalCost > 0 ? totalCost.toFixed(2) : '0.00'}</span>\r\n                        </div>\r\n                        <div style={{ display: 'flex', justifyContent: 'space-between', color: '#aaa', marginTop: '4px' }}>\r\n                            <span>{lang === 'en' ? 'My wallet:' : '鎴戠殑浣欓锛?}</span>\r\n                            <span style={{ color: overBudget ? '#e53935' : '#7B9FE0' }}>楼{(userWallet ?? 0).toFixed(2)}</span>\r\n                        </div>\r\n                        {overBudget && <div style={{ color: '#e53935', fontSize: '12px', marginTop: '6px' }}>鈿狅笍 {lang === 'en' ? 'Insufficient balance' : '浣欓涓嶈冻'}</div>}\r\n                    </div>\r\n                    <button onClick={onSend} disabled={!isValid}\r\n                        style={{ width: '100%', padding: '13px', background: isValid ? 'linear-gradient(135deg,#d63031,#c0392b)' : '#ccc', color: '#fff', border: 'none', borderRadius: '10px', cursor: isValid ? 'pointer' : 'not-allowed', fontSize: '15px', fontWeight: '700' }}>\r\n                        {lang === 'en' ? '馃Ё Send' : '馃Ё 濉為挶杩涚孩鍖?}\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\n/* 鈹€鈹€鈹€ Red Packet Card (parsed from [REDPACKET:id] in content) 鈹€鈹€鈹€ */\r\nfunction RedPacketCard({ packetId, apiUrl, groupId, isUser, resolveSender }) {\r\n    const { lang } = useLanguage();\r\n    const [pkt, setPkt] = useState(null);\r\n    const [showDetail, setShowDetail] = useState(false);\r\n\r\n    const loadPkt = async () => {\r\n        try { const r = await fetch(`${apiUrl}/groups/${groupId}/redpackets/${packetId}`); setPkt(await r.json()); } catch (e) { console.error(e); }\r\n    };\r\n    useEffect(() => { if (packetId) loadPkt(); }, [packetId]);\r\n\r\n    const handleClaim = async () => {\r\n        try { await fetch(`${apiUrl}/groups/${groupId}/redpackets/${packetId}/claim`, { method: 'POST' }); loadPkt(); } catch (e) { console.error(e); }\r\n    };\r\n\r\n    if (!pkt) return <div style={{ padding: '8px', color: '#aaa', fontSize: '13px' }}>馃Ё Loading...</div>;\r\n    const isExpired = pkt.claims?.length >= pkt.count;\r\n    const userClaimed = pkt.claims?.some(c => c.claimer_id === 'user');\r\n\r\n    return (\r\n        <div style={{ background: 'linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%)', borderRadius: '12px', padding: '12px 14px', minWidth: '200px', maxWidth: '260px', border: '1px solid #ffccbc', cursor: 'pointer' }}\r\n            onClick={() => setShowDetail(!showDetail)}>\r\n            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '6px' }}>\r\n                <span style={{ fontSize: '24px' }}>馃Ё</span>\r\n                <div>\r\n                    <div style={{ fontWeight: '600', fontSize: '14px', color: '#c0392b' }}>{pkt.note || (lang === 'en' ? 'Red Packet' : '绾㈠寘')}</div>\r\n                    <div style={{ fontSize: '11px', color: '#999' }}>\r\n                        {pkt.type === 'fixed' ? (lang === 'en' ? 'Regular' : '鏅€氱孩鍖?) : (lang === 'en' ? 'Lucky' : '鎷兼墜姘旂孩鍖?)}\r\n                        {' 路 '}{pkt.claims?.length || 0}/{pkt.count}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            {!isExpired && !userClaimed && !isUser && (\r\n                <button onClick={e => { e.stopPropagation(); handleClaim(); }}\r\n                    style={{ width: '100%', padding: '8px', background: '#c0392b', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600', fontSize: '13px' }}>\r\n                    {lang === 'en' ? '馃Ё Open' : '馃Ё 鎷嗙孩鍖?}\r\n                </button>\r\n            )}\r\n            {(isExpired || userClaimed) && (\r\n                <div style={{ fontSize: '12px', color: '#999', textAlign: 'center' }}>\r\n                    {userClaimed ? (lang === 'en' ? '鉁?Claimed' : '鉁?宸查鍙?) : (lang === 'en' ? 'All claimed' : '宸叉姠瀹?)}\r\n                </div>\r\n            )}\r\n            {showDetail && (\r\n                <div style={{ background: '#fff8f0', borderRadius: '10px', padding: '10px 12px', marginTop: '6px', border: '1px solid #ffe0b2' }}>\r\n                    <div style={{ fontSize: '12px', color: '#888', marginBottom: '6px', display: 'flex', justifyContent: 'space-between' }}>\r\n                        <span>{lang === 'en' ? 'Claims:' : '棰嗗彇璁板綍'}</span>\r\n                        <span>楼{pkt.total_amount?.toFixed(2)} {lang === 'en' ? 'total' : '鎬昏'}</span>\r\n                    </div>\r\n                    {(!pkt.claims || pkt.claims.length === 0) && <div style={{ fontSize: '12px', color: '#bbb' }}>{lang === 'en' ? 'No one yet' : '鏆傛棤浜洪鍙?}</div>}\r\n                    {pkt.claims?.map((c, i) => {\r\n                        const s = resolveSender(c.claimer_id);\r\n                        return (\r\n                            <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>\r\n                                <img src={s.avatar} alt=\"\" style={{ width: 22, height: 22, borderRadius: '50%', objectFit: 'cover' }} />\r\n                                <span style={{ fontSize: '13px', flex: 1 }}>{s.name}</span>\r\n                                <span style={{ fontSize: '13px', color: '#c0392b', fontWeight: '600' }}>楼{c.amount?.toFixed(2)}</span>\r\n                            </div>\r\n                        );\r\n                    })}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\n/* 鈹€鈹€鈹€ Right-side Group Management Drawer 鈹€鈹€鈹€ */\r\nfunction GroupManageDrawer({ group, apiUrl, allContacts, resolveSender, onClose, lang }) {\r\n    const [isPaused, setIsPaused] = useState(false);\r\n    const [noChain, setNoChain] = useState(false);\r\n\r\n    useEffect(() => {\r\n        if (!group) return;\r\n        fetch(`${apiUrl}/groups/${group.id}/ai-pause`).then(r => r.json()).then(d => setIsPaused(!!d.paused)).catch(() => { });\r\n        fetch(`${apiUrl}/groups/${group.id}/no-chain`).then(r => r.json()).then(d => setNoChain(!!d.no_chain)).catch(() => { });\r\n    }, [group, apiUrl]);\r\n\r\n    const togglePause = async () => {\r\n        const v = !isPaused; setIsPaused(v);\r\n        fetch(`${apiUrl}/groups/${group.id}/ai-pause`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ paused: v }) });\r\n    };\r\n    const toggleNoChain = async () => {\r\n        const v = !noChain; setNoChain(v);\r\n        fetch(`${apiUrl}/groups/${group.id}/no-chain`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ no_chain: v }) });\r\n    };\r\n    const clearMessages = () => { if (window.confirm(lang === 'en' ? 'Clear all messages?' : '娓呯┖鎵€鏈夋秷鎭紵')) fetch(`${apiUrl}/groups/${group.id}/messages`, { method: 'DELETE' }).then(() => window.location.reload()); };\r\n    const dissolveGroup = () => { if (window.confirm(lang === 'en' ? 'Dissolve this group?' : '瑙ｆ暎姝ょ兢锛?)) fetch(`${apiUrl}/groups/${group.id}`, { method: 'DELETE' }).then(() => window.location.reload()); };\r\n    const kickMember = (mid) => { if (window.confirm(lang === 'en' ? 'Remove this member?' : '绉婚櫎姝ゆ垚鍛橈紵')) fetch(`${apiUrl}/groups/${group.id}/members/${mid}`, { method: 'DELETE' }).then(() => window.location.reload()); };\r\n\r\n\r\n    return (\r\n        <div style={{ width: '280px', minWidth: '280px', backgroundColor: '#f7f7f7', borderLeft: '1px solid #eee', display: 'flex', flexDirection: 'column', height: '100%', overflowY: 'auto' }}>\r\n            {/* Header */}\r\n            <div style={{ padding: '12px 15px', borderBottom: '1px solid #eee', display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: '#fff' }}>\r\n                <h3 style={{ margin: 0, fontSize: '15px', display: 'flex', alignItems: 'center', gap: '6px' }}>\r\n                    <Settings size={16} /> {lang === 'en' ? 'Group Management' : '缇ょ鐞?}\r\n                </h3>\r\n                <button onClick={onClose} style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#999' }}><X size={18} /></button>\r\n            </div>\r\n\r\n            {/* Members */}\r\n            <div style={{ backgroundColor: '#fff', padding: '12px 15px', borderBottom: '1px solid #eee' }}>\r\n                <div style={{ fontSize: '12px', color: '#999', marginBottom: '10px', textTransform: 'uppercase' }}>\r\n                    {lang === 'en' ? 'Members' : '缇ゆ垚鍛?} ({group.members?.length || 0})\r\n                </div>\r\n                {group.members?.map(memberObj => {\r\n                    const mid = memberObj.member_id || memberObj;\r\n                    const m = resolveSender(mid);\r\n                    return (\r\n                        <div key={mid} style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '5px 0' }}>\r\n                            <img src={m.avatar} alt=\"\" style={{ width: 30, height: 30, borderRadius: '6px', objectFit: 'cover' }} />\r\n                            <span style={{ flex: 1, fontSize: '13px' }}>{m.name}</span>\r\n                            {mid !== 'user' && (\r\n                                <button onClick={() => kickMember(mid)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#F06B8E', padding: '2px' }} title={lang === 'en' ? 'Remove member from group' : '灏嗚鎴愬憳韪㈠嚭缇よ亰'}>\r\n                                    <UserMinus size={14} />\r\n                                </button>\r\n                            )}\r\n                        </div>\r\n                    );\r\n                })}\r\n            </div>\r\n\r\n            {/* AI Controls */}\r\n            <div style={{ backgroundColor: '#fff', padding: '12px 15px', borderBottom: '1px solid #eee', marginTop: '8px' }}>\r\n                <div style={{ fontSize: '12px', color: '#999', marginBottom: '10px', textTransform: 'uppercase' }}>\r\n                    {lang === 'en' ? 'AI Controls' : 'AI 鎺у埗'}\r\n                </div>\r\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: '14px' }}>\r\n                    <span>{lang === 'en' ? '鈿?Prevent AI Chaining' : '鈿?绂佹AI浜掔浉鎺ヨ瘽'}</span>\r\n                    <label style={{ position: 'relative', display: 'inline-block', width: '44px', height: '24px' }}>\r\n                        <input type=\"checkbox\" checked={noChain} onChange={toggleNoChain} style={{ opacity: 0, width: 0, height: 0 }} />\r\n                        <span style={{ position: 'absolute', cursor: 'pointer', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: noChain ? '#7B9FE0' : '#ccc', borderRadius: '24px', transition: '0.3s' }}>\r\n                            <span style={{ position: 'absolute', height: '18px', width: '18px', left: noChain ? '23px' : '3px', bottom: '3px', backgroundColor: 'white', borderRadius: '50%', transition: '0.3s' }} />\r\n                        </span>\r\n                    </label>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Danger Zone */}\r\n            <div style={{ backgroundColor: '#fff', padding: '12px 15px', marginTop: '8px' }}>\r\n                <div style={{ fontSize: '12px', color: '#999', marginBottom: '10px', textTransform: 'uppercase' }}>\r\n                    {lang === 'en' ? 'Danger Zone' : '鍗遍櫓鎿嶄綔'}\r\n                </div>\r\n                <button onClick={clearMessages} title={lang === 'en' ? 'Delete all messages in this group' : '娓呯┖缇よ亰涓殑鎵€鏈夋秷鎭?} style={{ width: '100%', padding: '10px', background: '#fff', border: '1px solid #ddd', borderRadius: '6px', cursor: 'pointer', fontSize: '13px', marginBottom: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '6px' }}>\r\n                    <Trash2 size={14} /> {lang === 'en' ? 'Clear Messages' : '娓呯┖娑堟伅'}\r\n                </button>\r\n                <button onClick={dissolveGroup} title={lang === 'en' ? 'Permanently dissolve this group chat' : '姘镐箙瑙ｆ暎姝ょ兢鑱?} style={{ width: '100%', padding: '10px', background: '#F06B8E', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '6px' }}>\r\n                    馃挜 {lang === 'en' ? 'Dissolve Group' : '瑙ｆ暎缇よ亰'}\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\n/* 鈹€鈹€鈹€ Main GroupChatWindow 鈹€鈹€鈹€ */\r\nfunction GroupChatWindow({ group, apiUrl, allContacts, userProfile, newGroupMessage, typingIndicators = [] }) {\r\n    const { lang } = useLanguage();\r\n    const [messages, setMessages] = useState([]);\r\n    const [input, setInput] = useState('');\r\n    const [showEmojiPicker, setShowEmojiPicker] = useState(false);\r\n    const [showRedPacketModal, setShowRedPacketModal] = useState(false);\r\n    const [showManageDrawer, setShowManageDrawer] = useState(false);\r\n    const messagesEndRef = useRef(null);\r\n    const fileInputRef = useRef(null);\r\n\r\n    useEffect(() => {\r\n        if (!group?.id) return;\r\n        setMessages([]); setShowManageDrawer(false);\r\n        fetch(`${apiUrl}/groups/${group.id}/messages`).then(r => r.json()).then(setMessages).catch(console.error);\r\n    }, [group?.id, apiUrl]);\r\n\r\n    useEffect(() => {\r\n        if (newGroupMessage && group?.id && newGroupMessage.group_id === group.id) {\r\n            setMessages(prev => prev.find(m => m.id === newGroupMessage.id) ? prev : [...prev, newGroupMessage]);\r\n        }\r\n    }, [newGroupMessage, group?.id]);\r\n\r\n    useEffect(() => {\r\n        if (messagesEndRef.current) {\r\n            messagesEndRef.current.scrollIntoView({ behavior: 'smooth', block: 'end' });\r\n        }\r\n    }, [messages]);\r\n\r\n    const handleSend = async () => {\r\n        if (!input.trim() || !group) return;\r\n        const text = input.trim(); setInput('');\r\n        try { await fetch(`${apiUrl}/groups/${group.id}/messages`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: text }) }); } catch (e) { console.error(e); }\r\n    };\r\n\r\n    const handleFileChange = (e) => {\r\n        const file = e.target.files[0]; if (!file) return;\r\n        e.target.value = '';\r\n        if (file.size > 100 * 1024) { alert(lang === 'en' ? `File too large (${(file.size / 1024).toFixed(1)} KB). Max 100 KB.` : `鏂囦欢澶ぇ銆傛渶澶?100 KB銆俙); return; }\r\n        const reader = new FileReader();\r\n        reader.onload = (ev) => { const snippet = `馃搫 [${file.name}]\\n${ev.target.result}`; setInput(prev => prev ? prev + '\\n' + snippet : snippet); };\r\n        reader.onerror = () => alert(lang === 'en' ? 'Failed to read file' : '璇诲彇鏂囦欢澶辫触');\r\n        reader.readAsText(file, 'utf-8');\r\n    };\r\n\r\n    const resolveSender = (senderId) => {\r\n        if (senderId === 'user') return { name: userProfile?.name || 'User', avatar: userProfile?.avatar || 'https://api.dicebear.com/7.x/notionists/svg?seed=User' };\r\n        const char = allContacts?.find(c => String(c.id) === String(senderId));\r\n        return char || { name: senderId, avatar: `https://api.dicebear.com/7.x/pixel-art/svg?seed=${senderId}` };\r\n    };\r\n\r\n    const addEmoji = (emoji) => { setInput(prev => prev + emoji); setShowEmojiPicker(false); };\r\n\r\n    // Parse message content to detect special types\r\n    const parseContent = (content) => {\r\n        if (!content) return { type: 'text', text: '' };\r\n        // Red packet: [REDPACKET:123]\r\n        const rpMatch = content.trim().match(/^\\[REDPACKET:(\\d+)\\]\\s*$/);\r\n        if (rpMatch) return { type: 'redpacket', packetId: parseInt(rpMatch[1]) };\r\n        // Transfer: [TRANSFER] amount | note\r\n        if (content.startsWith('[TRANSFER]')) return { type: 'transfer', content };\r\n        // System\r\n        if (content.startsWith('[System]')) return { type: 'system', text: content.replace('[System] ', '') };\r\n        return { type: 'text', text: content };\r\n    };\r\n\r\n    if (!group) return null;\r\n\r\n    return (\r\n        <>\r\n            <div style={{ display: 'flex', flexDirection: 'column', flex: 1, height: '100%', minWidth: 0 }}>\r\n                {/* Header */}\r\n                <div className=\"chat-header\">\r\n                    <div className=\"chat-header-title\" style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>\r\n                        <Users size={20} />\r\n                        {group.name}\r\n                        <span style={{ fontSize: '12px', color: '#999' }}>({group.members?.length || 0})</span>\r\n                    </div>\r\n                    <div style={{ display: 'flex', gap: '4px', alignItems: 'center' }}>\r\n                        <button onClick={() => setShowManageDrawer(!showManageDrawer)}\r\n                            style={{ background: 'none', border: 'none', cursor: 'pointer', color: showManageDrawer ? '#F06B8E' : '#7B9FE0' }}\r\n                            title={lang === 'en' ? 'Group management 鈥?members, AI controls, danger zone' : '缇ょ鐞?鈥?鎴愬憳銆丄I 鎺у埗銆佸嵄闄╂搷浣?}>\r\n                            <Settings size={20} />\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Messages */}\r\n                <div className=\"chat-history\">\r\n                    {messages.map(msg => {\r\n                        const sender = resolveSender(msg.sender_id);\r\n                        const isUser = msg.sender_id === 'user';\r\n                        const parsed = parseContent(msg.content);\r\n\r\n                        // System message\r\n                        if (msg.sender_id === 'system' || parsed.type === 'system') {\r\n                            return (\r\n                                <div key={msg.id} style={{ textAlign: 'center', margin: '8px 0' }}>\r\n                                    <span style={{ fontSize: '12px', color: '#aaa', backgroundColor: '#f0f0f0', padding: '3px 10px', borderRadius: '10px' }}>\r\n                                        {parsed.text || (msg.content || '').replace('[System] ', '')}\r\n                                    </span>\r\n                                </div>\r\n                            );\r\n                        }\r\n\r\n                        // Red packet\r\n                        if (parsed.type === 'redpacket') {\r\n                            return (\r\n                                <div key={msg.id} className={`message-wrapper ${isUser ? 'user' : 'character'}`}>\r\n                                    <div className=\"message-avatar\"><img src={sender.avatar} alt=\"\" /></div>\r\n                                    <div className=\"message-content\">\r\n                                        {!isUser && <div style={{ fontSize: '12px', color: '#7B9FE0', marginBottom: '2px', fontWeight: '500' }}>{sender.name}</div>}\r\n                                        <RedPacketCard packetId={parsed.packetId} apiUrl={apiUrl} groupId={group.id} isUser={isUser} resolveSender={resolveSender} />\r\n                                    </div>\r\n                                </div>\r\n                            );\r\n                        }\r\n\r\n                        // Transfer\r\n                        if (parsed.type === 'transfer') {\r\n                            const raw = parsed.content.replace('[TRANSFER]', '').trim();\r\n                            const parts = raw.split('|');\r\n                            const amount = parts[0].trim();\r\n                            const note = parts.length > 1 ? parts.slice(1).join('|').trim() : 'Transfer';\r\n                            return (\r\n                                <div key={msg.id} className={`message-wrapper ${isUser ? 'user' : 'character'}`}>\r\n                                    <div className=\"message-avatar\"><img src={sender.avatar} alt=\"\" /></div>\r\n                                    <div className=\"message-content\">\r\n                                        {!isUser && <div style={{ fontSize: '12px', color: '#7B9FE0', marginBottom: '2px', fontWeight: '500' }}>{sender.name}</div>}\r\n                                        <div className=\"message-bubble transfer-bubble\">\r\n                                            <div className=\"transfer-icon-area\"><ArrowRightLeft size={24} color=\"#fff\" /></div>\r\n                                            <div className=\"transfer-text-area\">\r\n                                                <div className=\"transfer-amount\">楼{amount}</div>\r\n                                                <div className=\"transfer-note\">{note}</div>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            );\r\n                        }\r\n\r\n                        // Normal message\r\n                        return (\r\n                            <div key={msg.id} className={`message-wrapper ${isUser ? 'user' : 'character'}`}>\r\n                                <div className=\"message-avatar\"><img src={sender.avatar} alt=\"\" /></div>\r\n                                <div className=\"message-content\">\r\n                                    {!isUser && <div style={{ fontSize: '12px', color: '#7B9FE0', marginBottom: '2px', fontWeight: '500' }}>{sender.name}</div>}\r\n                                    <div className=\"message-bubble\">{msg.content}</div>\r\n                                </div>\r\n                            </div>\r\n                        );\r\n                    })}\r\n                    <div ref={messagesEndRef} />\r\n                </div>\r\n\r\n                {/* Typing indicators and Interrupt Button */}\r\n                {(typingIndicators.length > 0) && (\r\n                    <div style={{ padding: '4px 15px 8px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                        <div style={{ color: '#999', fontSize: '13px', fontStyle: 'italic', display: 'flex', alignItems: 'center', gap: '6px' }}>\r\n                            <span style={{ display: 'inline-block', animation: 'pulse 1.5s infinite' }}>鉁?/span>\r\n                            {typingIndicators.map(t => t.name).join(', ')} {lang === 'en' ? 'typing...' : '姝ｅ湪杈撳叆涓?..'}\r\n                        </div>\r\n                        <button\r\n                            onClick={async () => {\r\n                                // Instantly interrupt AIs\r\n                                await fetch(`${apiUrl}/groups/${group.id}/ai-pause`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ paused: true }) });\r\n                                // Automatically unpause after 10 seconds or when user sends a message\r\n                                setTimeout(() => {\r\n                                    fetch(`${apiUrl}/groups/${group.id}/ai-pause`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ paused: false }) });\r\n                                }, 10000);\r\n                            }}\r\n                            title={lang === 'en' ? 'Interrupt AIs and stop them from chaining texts' : '鎵撴柇 AI 鐨勮繛缁彂瑷€'}\r\n                            style={{\r\n                                display: 'flex', alignItems: 'center', gap: '4px', background: '#fff0f0', border: '1px solid #ffcccc', color: '#F06B8E',\r\n                                padding: '4px 10px', borderRadius: '14px', fontSize: '12px', fontWeight: 'bold', cursor: 'pointer', boxShadow: '0 2px 5px rgba(240,107,142,0.1)'\r\n                            }}\r\n                        >\r\n                            鉁?{lang === 'en' ? 'Interrupt' : '鎵撴柇'}\r\n                        </button>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Input area 鈥?matches private chat InputBar style */}\r\n                <div className=\"input-area\">\r\n                    <div className=\"input-toolbar\" style={{ position: 'relative' }}>\r\n                        <button onClick={() => setShowEmojiPicker(!showEmojiPicker)} title={lang === 'en' ? 'Insert emoji' : '鎻掑叆琛ㄦ儏'}><Smile size={20} /></button>\r\n                        <button onClick={() => fileInputRef.current?.click()} title={lang === 'en' ? 'Send file' : '鍙戦€佹枃浠?}><Paperclip size={20} /></button>\r\n                        <input ref={fileInputRef} type=\"file\" accept=\".txt,.md,.csv,.json,.log,.py,.js,.ts,.html,.css,.xml,.yaml,.yml\" style={{ display: 'none' }} onChange={handleFileChange} />\r\n                        <button onClick={() => setShowRedPacketModal(true)} title={lang === 'en' ? 'Send red packet 鈥?lucky money for group' : '鍙戠孩鍖?鈥?缁欑兢鍙嬪彂璐㈣繍'}>\r\n                            <Gift size={20} color=\"#F06B8E\" />\r\n                        </button>\r\n\r\n                        {showEmojiPicker && (\r\n                            <div className=\"emoji-picker\" style={{ position: 'absolute', bottom: '50px', left: '10px', backgroundColor: '#fff', border: '1px solid #ddd', borderRadius: '8px', padding: '10px', display: 'flex', flexWrap: 'wrap', gap: '5px', width: '220px', boxShadow: '0 -4px 12px rgba(0,0,0,0.1)', zIndex: 100 }}>\r\n                                <div style={{ width: '100%', display: 'flex', justifyContent: 'flex-end', marginBottom: '5px' }}>\r\n                                    <button onClick={() => setShowEmojiPicker(false)} style={{ padding: '2px' }}><X size={14} /></button>\r\n                                </div>\r\n                                {quickEmojis.map(e => (\r\n                                    <span key={e} onClick={() => addEmoji(e)} style={{ fontSize: '20px', cursor: 'pointer', padding: '4px', borderRadius: '4px' }}>{e}</span>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                    <div className=\"input-textarea-wrapper\">\r\n                        <textarea\r\n                            className=\"input-textarea\"\r\n                            value={input}\r\n                            onChange={e => setInput(e.target.value)}\r\n                            onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } }}\r\n                            placeholder={lang === 'en' ? 'Type a message...' : '杈撳叆娑堟伅...'}\r\n                        />\r\n                    </div>\r\n                    <div className=\"input-actions\">\r\n                        <button className=\"send-button\" onClick={handleSend}>{lang === 'en' ? 'Send' : '鍙戦€?}</button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Right-side Management Drawer */}\r\n            {showManageDrawer && (\r\n                <GroupManageDrawer group={group} apiUrl={apiUrl} allContacts={allContacts} resolveSender={resolveSender}\r\n                    onClose={() => setShowManageDrawer(false)} lang={lang} />\r\n            )}\r\n\r\n            {/* Red Packet Modal */}\r\n            {showRedPacketModal && (\r\n                <RedPacketModal group={group} apiUrl={apiUrl} onClose={() => setShowRedPacketModal(false)} userWallet={userProfile?.wallet ?? 100} />\r\n            )}\r\n        </>\r\n    );\r\n}\r\n\r\nexport default GroupChatWindow;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\components\\InputBar.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\components\\MemoTable.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchMemories'. Either include it or remove the dependency array.","line":32,"column":8,"nodeType":"ArrayExpression","endLine":32,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [contact, apiUrl, fetchMemories]","fix":{"range":[1090,1107],"text":"[contact, apiUrl, fetchMemories]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { Trash2, RefreshCw, Wand2, X } from 'lucide-react';\r\nimport { useLanguage } from '../LanguageContext';\r\n\r\nfunction MemoTable({ contact, apiUrl, onClose }) {\r\n    const { t, lang } = useLanguage();\r\n    const [memories, setMemories] = useState([]);\r\n    const [loading, setLoading] = useState(false);\r\n    const [isExtracting, setIsExtracting] = useState(false);\r\n\r\n    const fetchMemories = () => {\r\n        if (!contact) return;\r\n        setLoading(true);\r\n        fetch(`${apiUrl}/memories/${contact.id}`)\r\n            .then(res => res.json())\r\n            .then(data => {\r\n                if (!Array.isArray(data)) {\r\n                    console.error('API Error:', data);\r\n                    data = [];\r\n                }\r\n                setMemories(data);\r\n                setLoading(false);\r\n            })\r\n            .catch(err => {\r\n                console.error('Failed to load memories:', err);\r\n                setLoading(false);\r\n            });\r\n    };\r\n\r\n    useEffect(() => {\r\n        fetchMemories();\r\n    }, [contact, apiUrl]);\r\n\r\n    const handleDelete = async (id) => {\r\n        try {\r\n            await fetch(`${apiUrl}/memories/${id}`, { method: 'DELETE' });\r\n            setMemories(prev => prev.filter(m => m.id !== id));\r\n        } catch (e) {\r\n            console.error('Failed to delete memory:', e);\r\n        }\r\n    };\r\n\r\n    const handleExtract = async () => {\r\n        if (!contact) return;\r\n        setIsExtracting(true);\r\n        try {\r\n            const res = await fetch(`${apiUrl}/memories/${contact.id}/extract`, { method: 'POST' });\r\n            const data = await res.json();\r\n\r\n            if (!res.ok) {\r\n                alert(lang === 'en' ? `Extraction Failed:\\n${data.error}` : `鎻愬彇澶辫触:\\n${data.error}`);\r\n            } else {\r\n                alert(lang === 'en' ? `Extraction Complete:\\n${data.message}` : `鎻愬彇瀹屾垚:\\n${data.message}`);\r\n                fetchMemories(); // Refresh the list if successful\r\n            }\r\n        } catch (e) {\r\n            console.error('Failed to extract memories:', e);\r\n            alert(lang === 'en' ? 'Failed to connect to the server for memory extraction.' : '鏃犳硶杩炴帴鏈嶅姟鍣ㄦ彁鍙栬蹇嗐€?);\r\n        } finally {\r\n            setIsExtracting(false);\r\n        }\r\n    };\r\n\r\n    if (!contact) return null;\r\n\r\n    console.log('MemoTable rendering:', { contact: contact?.name, memoriesLength: memories.length, loading });\r\n\r\n    return (\r\n        <div className=\"drawer-container memory-drawer\">\r\n            <div className=\"memory-header\">\r\n                <h3>{contact.name} {lang === 'en' ? \"'s Memories\" : \"鐨勮蹇哱"}</h3>\r\n                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>\r\n                    <button\r\n                        onClick={handleExtract}\r\n                        disabled={isExtracting}\r\n                        style={{ display: 'flex', alignItems: 'center', gap: '5px', padding: '4px 8px', backgroundColor: isExtracting ? '#ccc' : '#7B9FE0', color: '#fff', border: 'none', borderRadius: '4px', cursor: isExtracting ? 'not-allowed' : 'pointer', fontSize: '13px' }}\r\n                    >\r\n                        <Wand2 size={14} /> {isExtracting ? (lang === 'en' ? 'Extracting...' : '鎻愬彇涓?..') : (lang === 'en' ? 'Extract Now' : '绔嬪嵆鎻愬彇')}\r\n                    </button>\r\n                    <button className=\"icon-btn\" onClick={fetchMemories} title={lang === 'en' ? \"Refresh\" : \"鍒锋柊\"}>\r\n                        <RefreshCw size={16} />\r\n                    </button>\r\n                    <button className=\"icon-btn\" onClick={onClose} title={t('Cancel')}>\r\n                        <X size={16} />\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"memory-content\">\r\n                {loading || isExtracting ? (\r\n                    <p className=\"loading-text\">{isExtracting ? (lang === 'en' ? 'Analyzing recent context...' : '鍒嗘瀽鏈€杩戠殑涓婁笅鏂?..') : (lang === 'en' ? 'Loading memories...' : '鍔犺浇璁板繂涓?..')}</p>\r\n                ) : memories.length === 0 ? (\r\n                    <div style={{ padding: '20px', textAlign: 'center', color: '#888' }}>\r\n                        <p>{t('No memories yet')}</p>\r\n                        <p style={{ fontSize: '12px', marginTop: '10px' }}>{lang === 'en' ? 'The AI usually extracts them in the background, but you can force an extraction now.' : 'AI 閫氬父浼氬湪鍚庡彴鎻愬彇璁板繂锛屼絾鎮ㄥ彲浠ョ偣鍑讳笂鏂规寜閽己鍒剁珛鍗虫彁鍙栥€?}</p>\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"memory-list\">\r\n                        {memories.map(mem => (\r\n                            <div key={mem.id} className=\"memory-card\">\r\n                                <div className=\"memory-card-header\">\r\n                                    <span className=\"memory-time\">{new Date(mem.created_at).toLocaleString()}</span>\r\n                                    <button className=\"icon-btn danger\" onClick={() => handleDelete(mem.id)}>\r\n                                        <Trash2 size={14} />\r\n                                    </button>\r\n                                </div>\r\n                                <div className=\"memory-card-body\">\r\n                                    <strong>{lang === 'en' ? 'Event' : '浜嬩欢'}:</strong> {mem.event}\r\n                                </div>\r\n                                {(mem.time || mem.location || mem.people) && (\r\n                                    <div className=\"memory-card-footer\">\r\n                                        {mem.time && <span>馃晵 {mem.time}</span>}\r\n                                        {mem.location && <span>馃搷 {mem.location}</span>}\r\n                                        {mem.people && <span>馃懃 {mem.people}</span>}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default MemoTable;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\components\\MessageBubble.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\components\\MomentsFeed.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchMomentsData'. Either include it or remove the dependency array.","line":42,"column":8,"nodeType":"ArrayExpression","endLine":42,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [apiUrl, fetchMomentsData]","fix":{"range":[1508,1516],"text":"[apiUrl, fetchMomentsData]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { Heart, MessageCircle, Send, Trash2 } from 'lucide-react';\r\nimport { useLanguage } from '../LanguageContext';\r\n\r\nfunction MomentsFeed({ apiUrl, userProfile }) {\r\n    const { t } = useLanguage();\r\n    const [moments, setMoments] = useState([]);\r\n    const [characters, setCharacters] = useState({});\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    // New Moment Post State\r\n    const [newPostText, setNewPostText] = useState('');\r\n    const [posting, setPosting] = useState(false);\r\n\r\n    // Comment State (keyed by moment id)\r\n    const [commentTexts, setCommentTexts] = useState({});\r\n    const [activeCommentBox, setActiveCommentBox] = useState(null);\r\n\r\n    const fetchMomentsData = () => {\r\n        // Fetch characters for mapping avatars/names\r\n        fetch(`${apiUrl}/characters`)\r\n            .then(res => res.json())\r\n            .then(data => {\r\n                const charMap = {};\r\n                data.forEach(c => charMap[c.id] = c);\r\n                setCharacters(charMap);\r\n                return fetch(`${apiUrl}/moments`);\r\n            })\r\n            .then(res => res.json())\r\n            .then(data => {\r\n                setMoments(data);\r\n                setLoading(false);\r\n            })\r\n            .catch(err => {\r\n                console.error('Failed to load moments/characters:', err);\r\n                setLoading(false);\r\n            });\r\n    };\r\n\r\n    useEffect(() => {\r\n        fetchMomentsData();\r\n    }, [apiUrl]);\r\n\r\n    const handlePostMoment = async () => {\r\n        if (!newPostText.trim()) return;\r\n        setPosting(true);\r\n        try {\r\n            const res = await fetch(`${apiUrl}/moments`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ content: newPostText })\r\n            });\r\n            if (res.ok) {\r\n                setNewPostText('');\r\n                fetchMomentsData(); // refresh\r\n            }\r\n        } catch (e) {\r\n            console.error('Failed to post moment', e);\r\n        }\r\n        setPosting(false);\r\n    };\r\n\r\n    const handleLikeToggle = async (id) => {\r\n        try {\r\n            const res = await fetch(`${apiUrl}/moments/${id}/like`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ liker_id: 'user' })\r\n            });\r\n            const data = await res.json();\r\n            if (data.success) {\r\n                // Optimistically update the moments array without a full refetch\r\n                setMoments(prev => prev.map(m =>\r\n                    m.id === id ? { ...m, likers: data.likers } : m\r\n                ));\r\n            }\r\n        } catch (e) {\r\n            console.error('Like toggle failed', e);\r\n        }\r\n    };\r\n\r\n    const handlePostComment = async (momentId) => {\r\n        const text = commentTexts[momentId];\r\n        if (!text || !text.trim()) return;\r\n\r\n        try {\r\n            const res = await fetch(`${apiUrl}/moments/${momentId}/comment`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ author_id: 'user', content: text })\r\n            });\r\n            const data = await res.json();\r\n            if (data.success) {\r\n                setCommentTexts(prev => ({ ...prev, [momentId]: '' }));\r\n                setActiveCommentBox(null);\r\n                fetchMomentsData(); // refresh to get comments\r\n            }\r\n        } catch (e) {\r\n            console.error('Comment failed', e);\r\n        }\r\n    };\r\n\r\n    const handleDeleteMoment = async (momentId) => {\r\n        try {\r\n            const res = await fetch(`${apiUrl}/moments/${momentId}`, { method: 'DELETE' });\r\n            const data = await res.json();\r\n            if (data.success) {\r\n                setMoments(prev => prev.filter(m => m.id !== momentId));\r\n            }\r\n        } catch (e) {\r\n            console.error('Delete moment failed', e);\r\n        }\r\n    };\r\n\r\n    const formatTime = (ts) => {\r\n        const timeAgo = Math.round((Date.now() - ts) / 60000);\r\n        if (timeAgo < 1) return 'Just now';\r\n        if (timeAgo < 60) return `${timeAgo} mins ago`;\r\n        if (timeAgo < 1440) return `${Math.floor(timeAgo / 60)} hours ago`;\r\n        return `${Math.floor(timeAgo / 1440)} days ago`;\r\n    };\r\n\r\n    const resolveAuthor = (id) => {\r\n        if (id === 'user') return { name: userProfile?.name || 'User', avatar: userProfile?.avatar || 'https://api.dicebear.com/7.x/notionists/svg?seed=User' };\r\n        return characters[id] || { name: 'Unknown', avatar: 'https://api.dicebear.com/7.x/pixel-art/svg?seed=Unknown' };\r\n    };\r\n\r\n    if (loading) return <div className=\"placeholder-text\">Loading Moments...</div>;\r\n\r\n    return (\r\n        <div className=\"moments-feed\" style={{ paddingBottom: '80px' }}>\r\n            {/* Cover Photo Area */}\r\n            <div className=\"moments-cover\" style={{ marginBottom: '20px' }}>\r\n                <div className=\"moments-cover-user\">\r\n                    <span className=\"moments-cover-name\">{userProfile?.name || 'User'}</span>\r\n                    <img src={userProfile?.avatar || 'https://api.dicebear.com/7.x/notionists/svg?seed=User'} alt=\"Me\" className=\"moments-cover-avatar\" />\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"moments-list\">\r\n                {/* Post New Moment Area */}\r\n                <div style={{ backgroundColor: '#fff', padding: '15px', marginBottom: '20px', borderBottom: '1px solid #f0f0f0', borderRadius: '8px' }}>\r\n                    <div style={{ display: 'flex', gap: '10px' }}>\r\n                        <img src={userProfile?.avatar || 'https://api.dicebear.com/7.x/notionists/svg?seed=User'} style={{ width: '44px', height: '44px', borderRadius: '6px' }} alt=\"\" />\r\n                        <div style={{ flex: 1 }}>\r\n                            <textarea\r\n                                placeholder={t('Share something new')}\r\n                                value={newPostText}\r\n                                onChange={(e) => setNewPostText(e.target.value)}\r\n                                style={{ width: '100%', border: 'none', resize: 'none', minHeight: '60px', outline: 'none', fontSize: '15px' }}\r\n                            />\r\n                            <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: '10px' }}>\r\n                                <button\r\n                                    onClick={handlePostMoment}\r\n                                    disabled={posting || !newPostText.trim()}\r\n                                    style={{ background: '#7B9FE0', color: '#fff', border: 'none', padding: '6px 16px', borderRadius: '4px', cursor: 'pointer', opacity: (!newPostText.trim() || posting) ? 0.5 : 1 }}\r\n                                >\r\n                                    {posting ? t('Loading') : t('Post')}\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n\r\n                {moments.length === 0 ? (\r\n                    <p className=\"empty-text\" style={{ padding: '20px', textAlign: 'center' }}>{t('No moments yet')}</p>\r\n                ) : (\r\n                    moments.map(moment => {\r\n                        const author = resolveAuthor(moment.character_id);\r\n                        const isLikedByUser = (moment.likers || []).includes('user');\r\n\r\n                        return (\r\n                            <div key={moment.id} className=\"moment-post\" style={{ paddingBottom: '15px', marginBottom: '15px', borderBottom: '1px solid #f0f0f0' }}>\r\n                                <img src={author.avatar} alt={author.name} className=\"moment-avatar\" />\r\n                                <div className=\"moment-body\" style={{ flex: 1, minWidth: 0 }}>\r\n                                    <div className=\"moment-author\">{author.name}</div>\r\n                                    <div className=\"moment-content\" style={{ marginTop: '5px' }}>{moment.content}</div>\r\n                                    {moment.image_url && <img src={moment.image_url} alt=\"Attached\" className=\"moment-image\" />}\r\n\r\n                                    <div className=\"moment-footer\" style={{ marginTop: '10px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                                        <span className=\"moment-time\">{formatTime(moment.timestamp)}</span>\r\n                                        <div className=\"moment-actions\" style={{ display: 'flex', gap: '15px' }}>\r\n                                            {moment.character_id === 'user' && (\r\n                                                <button onClick={() => handleDeleteMoment(moment.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#999', display: 'flex', alignItems: 'center', gap: '4px' }} title=\"Delete\">\r\n                                                    <Trash2 size={16} />\r\n                                                </button>\r\n                                            )}\r\n                                            <button onClick={() => handleLikeToggle(moment.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '4px', color: isLikedByUser ? '#F06B8E' : '#7B9FE0' }}>\r\n                                                <Heart size={18} fill={isLikedByUser ? '#F06B8E' : 'none'} color={isLikedByUser ? '#F06B8E' : '#7B9FE0'} />\r\n                                                <span>{(moment.likers || []).length > 0 ? moment.likers.length : ''}</span>\r\n                                            </button>\r\n                                            <button onClick={() => setActiveCommentBox(activeCommentBox === moment.id ? null : moment.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#7B9FE0', display: 'flex', alignItems: 'center', gap: '4px' }}>\r\n                                                <MessageCircle size={18} />\r\n                                                <span>{(moment.comments || []).length > 0 ? moment.comments.length : ''}</span>\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {/* Interaction Display Area (Likes + Comments) */}\r\n                                    {((moment.likers && moment.likers.length > 0) || (moment.comments && moment.comments.length > 0)) && (\r\n                                        <div style={{ background: '#f8f8f8', marginTop: '10px', padding: '8px', borderRadius: '4px', fontSize: '13px' }}>\r\n\r\n                                            {/* Likes Text */}\r\n                                            {moment.likers && moment.likers.length > 0 && (\r\n                                                <div style={{ color: '#7B9FE0', display: 'flex', alignItems: 'center', gap: '5px', paddingBottom: (moment.comments && moment.comments.length > 0) ? '5px' : '0', borderBottom: (moment.comments && moment.comments.length > 0) ? '1px solid #eaeaea' : 'none' }}>\r\n                                                    <Heart size={12} fill=\"#7B9FE0\" />\r\n                                                    {moment.likers.map(lId => resolveAuthor(lId).name).join(', ')}\r\n                                                </div>\r\n                                            )}\r\n\r\n                                            {/* Comments List */}\r\n                                            {moment.comments && moment.comments.length > 0 && (\r\n                                                <div style={{ paddingTop: (moment.likers && moment.likers.length > 0) ? '5px' : '0' }}>\r\n                                                    {moment.comments.map(c => {\r\n                                                        const cAuthor = resolveAuthor(c.author_id);\r\n                                                        return (\r\n                                                            <div key={c.id} style={{ marginBottom: '3px', wordBreak: 'break-word' }}>\r\n                                                                <span style={{ color: '#7B9FE0', fontWeight: '500' }}>{cAuthor.name}: </span>\r\n                                                                <span style={{ color: '#333' }}>{c.content}</span>\r\n                                                            </div>\r\n                                                        );\r\n                                                    })}\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {/* Comment Input Box */}\r\n                                    {activeCommentBox === moment.id && (\r\n                                        <div style={{ display: 'flex', marginTop: '10px', gap: '5px' }}>\r\n                                            <input\r\n                                                type=\"text\"\r\n                                                value={commentTexts[moment.id] || ''}\r\n                                                onChange={e => setCommentTexts({ ...commentTexts, [moment.id]: e.target.value })}\r\n                                                placeholder=\"Comment...\"\r\n                                                style={{ flex: 1, padding: '6px 10px', border: '1px solid #ddd', borderRadius: '4px', outline: 'none' }}\r\n                                                onKeyDown={e => e.key === 'Enter' && handlePostComment(moment.id)}\r\n                                                autoFocus\r\n                                            />\r\n                                            <button onClick={() => handlePostComment(moment.id)} style={{ background: '#7B9FE0', color: '#fff', border: 'none', padding: '0 12px', borderRadius: '4px', cursor: 'pointer' }}>\r\n                                                <Send size={16} />\r\n                                            </button>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        );\r\n                    })\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default MomentsFeed;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\components\\RecommendModal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\components\\SettingsPanel.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'getDefaultGuidelines' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"getDefaultGuidelines"},"fix":{"range":[201,2394],"text":""},"desc":"Remove unused variable 'getDefaultGuidelines'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'handleWipeData' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":114,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":114,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"handleWipeData"},"fix":{"range":[5515,6115],"text":""},"desc":"Remove unused variable 'handleWipeData'."}]},{"ruleId":"no-undef","severity":2,"message":"'defaultGuidelines' is not defined.","line":267,"column":116,"nodeType":"Identifier","messageId":"undef","endLine":267,"endColumn":133}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { User, Trash2, Edit3, Save, Download, AlertTriangle, RefreshCw } from 'lucide-react';\r\nimport { useLanguage } from '../LanguageContext';\r\n\r\nconst getDefaultGuidelines = (lang) => {\r\n    if (lang === 'en') {\r\n        return `Guidelines:\r\n1. Act and speak EXACTLY like the persona. DO NOT break character.\r\n2. We are chatting on a mobile messaging app.\r\n3. Keep responses relatively short, casual, and conversational.\r\n4. DO NOT act as an AI assistant. Never say \"How can I help you?\".\r\n5. You are initiating this specific message randomly based on the Current Time. Mention the time of day or what you might be doing.\r\n6. [MANDATORY KNOWLEDGE FOR BACKGROUND ACTIONS]: \r\n   - If you want to wait a specific amount of time before your NEXT proactive message, output [TIMER:minutes]. \r\n   - If you want to apologize or send a \"Red Packet\" to the user, output [TRANSFER:amount] (e.g. [TRANSFER:5.20]).\r\n   - If you want to post a public update to your Moments (鏈嬪弸鍦? for everyone to see, output [MOMENT:your post content]. Do this occasionally.\r\n   - You can react to someone else's Moment (including the user's) using [MOMENT_LIKE:moment_id] or [MOMENT_COMMENT:moment_id:your comment text].\r\n   - If you want to write a secret entry in your private diary (for your eyes only), output [DIARY:your secret thought]. Do this if you are feeling very emotional.\r\n   - If your feelings toward the user change based on their message (e.g., they insulted you or flattered you), output [AFFINITY:+5] or [AFFINITY:-10].\r\n   - If your anxiety/pressure is relieved by their message, output [PRESSURE:0].\r\n   These tags will be processed hidden from the user.`;\r\n    }\r\n\r\n    return `琛屼负鍑嗗垯锛歕r\n1. 璇峰畬鍏ㄨ繘鍏ュ苟鎵紨浣犵殑瑙掕壊璁惧畾 (Persona)銆傜粷瀵逛笉鍙互鑴辩瑙掕壊銆俓r\n2. 鎴戜滑姝ｅ湪浣跨敤涓€涓Щ鍔ㄦ墜鏈鸿亰澶╄蒋浠躲€俓r\n3. 浣犵殑鍥炲闇€瑕佷繚鎸佺畝鐭€侀殢鎰忋€佸彛璇寲銆俓r\n4. 缁濆涓嶅彲浠ヨ〃鐜板緱鍍忎竴涓狝I鍔╂墜銆傜粷瀵逛笉鍙互闂€滄湁浠€涔堟垜鍙互甯綘鐨勫悧锛熲€濄€俓r\n5. 褰撲綘涓诲姩鍙戣捣瀵硅瘽鏃讹紝璇锋牴鎹綋鍓嶆椂闂磋嚜鐒跺湴鎵撴嫑鍛硷紝鎴栬€呮彁涓€涓嬩綘鐜板湪鍙兘鍦ㄥ仛鐨勪簨銆俓r\n6. [鍚庡彴鍔ㄤ綔鐨勫己鍒舵€ц鑼僝锛歕r\n   - 濡傛灉浣犳兂绛夊緟鍑犲垎閽熷悗鍐嶅彂閫佷笅涓€鏉′富鍔ㄦ秷鎭紝璇疯緭鍑烘爣绛?[TIMER:鍒嗛挓鏁癩銆俓r\n   - 濡傛灉浣犳兂琛ㄨ揪姝夋剰鎴栬€呭彂涓孩鍖咃紝璇疯緭鍑烘爣绛?[TRANSFER:閲戦] (渚嬪锛歔TRANSFER:5.20])銆俓r\n   - 濡傛灉浣犳兂鍙戜竴鏉″叕寮€鐨勬湅鍙嬪湀鍔ㄦ€侊紝璇疯緭鍑烘爣绛?[MOMENT:浣犵殑鍔ㄦ€佸唴瀹筣銆傝鍋跺皵杩欐牱鍋氥€俓r\n   - 濡傛灉浣犳兂缁欏埆浜虹殑鏈嬪弸鍦堬紙鍖呮嫭鎴戠殑锛夌偣璧炴垨璇勮锛岃浣跨敤 [MOMENT_LIKE:moment_id] 鎴?[MOMENT_COMMENT:moment_id:浣犵殑璇勮]銆俓r\n   - 濡傛灉浣犳儏缁縺鍔ㄦ兂瑕佸啓涓€娈电粷瀵圭瀵嗙殑绉佷汉鏃ヨ锛堜粎浣犲彲瑙侊級锛岃杈撳嚭鏍囩 [DIARY:浣犵殑绉樺瘑鎯虫硶]銆俓r\n   - 濡傛灉鍥犱负鎴戠殑璇濆鑷翠綘瀵规垜鐨勫ソ鎰熷害鏀瑰彉锛堣鍐掔姱鎴栬澶稿锛夛紝璇疯緭鍑烘爣绛?[AFFINITY:+5] 鎴?[AFFINITY:-10]銆俓r\n   - 濡傛灉鎴戠殑璇濊浣犺寰楁儏缁帇鍔涘緱鍒扮紦瑙ｏ紝璇疯緭鍑烘爣绛?[PRESSURE:0]銆俓r\n   浠ヤ笂鎵€鏈夌殑鎷彿鏍囩[TAG]鍦ㄥ鐞嗘椂閮戒細鍦ㄥ墠绔鎴戦殣钘忥紝浣嗘垜鑳界湅鍒板搴旂殑鏁堟灉銆俙;\r\n};\r\n\r\n\r\nfunction SettingsPanel({ apiUrl, contacts, onCharactersUpdate, onProfileUpdate }) {\r\n    const { t, lang } = useLanguage();\r\n    const [profile, setProfile] = useState(null);\r\n    const [isEditing, setIsEditing] = useState(false);\r\n    const [editName, setEditName] = useState('');\r\n    const [editAvatar, setEditAvatar] = useState('');\r\n    const [editBio, setEditBio] = useState('');\r\n    const [editingContact, setEditingContact] = useState(null);\r\n    // Model list fetch state (main API + memory API)\r\n    const [mainModels, setMainModels] = useState([]);\r\n    const [mainModelFetching, setMainModelFetching] = useState(false);\r\n    const [mainModelError, setMainModelError] = useState('');\r\n    const [memModels, setMemModels] = useState([]);\r\n    const [memModelFetching, setMemModelFetching] = useState(false);\r\n    const [memModelError, setMemModelError] = useState('');\r\n\r\n    const fetchModels = async (endpoint, key, setList, setFetching, setError) => {\r\n        if (!endpoint || !key) { setError('璇峰厛濉啓 Endpoint 鍜?Key'); return; }\r\n        setFetching(true); setError(''); setList([]);\r\n        try {\r\n            const res = await fetch(`${apiUrl}/models?endpoint=${encodeURIComponent(endpoint)}&key=${encodeURIComponent(key)}`);\r\n            const data = await res.json();\r\n            if (!res.ok) throw new Error(data.error);\r\n            setList(data.models || []);\r\n            if (!(data.models || []).length) setError('鏈壘鍒板彲鐢ㄦā鍨?);\r\n        } catch (e) { setError('鎷夊彇澶辫触: ' + e.message); }\r\n        setFetching(false);\r\n    };\r\n\r\n    useEffect(() => {\r\n        fetch(`${apiUrl}/user`)\r\n            .then(res => res.json())\r\n            .then(data => {\r\n                setProfile(data);\r\n                setEditName(data.name);\r\n                setEditAvatar(data.avatar || '');\r\n                setEditBio(data.bio);\r\n            });\r\n    }, [apiUrl]);\r\n\r\n    const handleSaveProfile = async () => {\r\n        const updated = { ...profile, name: editName, avatar: editAvatar, bio: editBio };\r\n        try {\r\n            const res = await fetch(`${apiUrl}/user`, {\r\n                method: 'PUT',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify(updated)\r\n            });\r\n            const data = await res.json();\r\n            if (data.success) {\r\n                setProfile(data.profile);\r\n                if (onProfileUpdate) onProfileUpdate(data.profile);\r\n                setIsEditing(false);\r\n            }\r\n        } catch (e) {\r\n            console.error('Failed to update profile:', e);\r\n        }\r\n    };\r\n\r\n    const handleDeleteContact = async (id) => {\r\n        if (!window.confirm(\"Are you sure you want to delete this contact and all their data?\")) return;\r\n        try {\r\n            const res = await fetch(`${apiUrl}/characters/${id}`, { method: 'DELETE' });\r\n            const data = await res.json();\r\n            if (data.success) {\r\n                if (onCharactersUpdate) onCharactersUpdate();\r\n            }\r\n        } catch (e) {\r\n            console.error('Failed to delete character:', e);\r\n        }\r\n    };\r\n\r\n    const handleWipeData = async (id) => {\r\n        if (!window.confirm('鈿狅笍 WARNING: This will OBLITERATE all chat history, SQL memories, moments, and Chroma vector files for this character. They will be a blank slate.\\n\\nAre you absolutely sure you want to proceed?')) return;\r\n        try {\r\n            await fetch(`${apiUrl}/data/${id}`, { method: 'DELETE' });\r\n            onCharactersUpdate();\r\n        } catch (e) {\r\n            console.error('Failed to wipe character data:', e);\r\n            alert(lang === 'en' ? 'Failed to wipe data: ' + e.message : '娓呴櫎鏁版嵁澶辫触: ' + e.message);\r\n        }\r\n    };\r\n\r\n    const handleSaveContact = async () => {\r\n        try {\r\n            const res = await fetch(`${apiUrl}/characters`, {\r\n                method: 'POST',  // Note: /characters POST handles updates too\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify(editingContact)\r\n            });\r\n            const data = await res.json();\r\n            if (res.ok) {\r\n                setEditingContact(null);\r\n                if (onCharactersUpdate) onCharactersUpdate();\r\n            } else {\r\n                alert(\"Failed to save: \" + data.error);\r\n            }\r\n        } catch (e) {\r\n            console.error('Failed to update contact:', e);\r\n        }\r\n    };\r\n\r\n    const handleFileUpload = async (event, setAvatarCallback) => {\r\n        const file = event.target.files[0];\r\n        if (!file) return;\r\n        const formData = new FormData();\r\n        formData.append('image', file);\r\n        try {\r\n            const res = await fetch(`${apiUrl}/upload`, { method: 'POST', body: formData });\r\n            const data = await res.json();\r\n            if (data.success) {\r\n                setAvatarCallback(data.url);\r\n            } else {\r\n                alert(lang === 'en' ? \"Failed to save: \" + data.error : \"淇濆瓨澶辫触: \" + data.error);\r\n            }\r\n        } catch (e) {\r\n            console.error('Upload Error:', e);\r\n            alert('Upload failed.');\r\n        }\r\n    };\r\n\r\n    if (!profile) return <div className=\"loading-text\">Loading settings...</div>;\r\n\r\n    return (\r\n        <>\r\n            <div style={{ padding: '30px', maxWidth: '600px', margin: '0 auto', width: '100%', display: 'flex', flexDirection: 'column', gap: '30px' }}>\r\n\r\n                {/* User Profile Section */}\r\n                <div style={{ backgroundColor: '#fff', padding: '20px', borderRadius: '8px', border: '1px solid #eee' }}>\r\n                    <h2 style={{ margin: '0 0 20px 0', fontSize: '18px', display: 'flex', alignItems: 'center', gap: '10px' }}>\r\n                        <User size={20} /> {t('User Profile')}\r\n                    </h2>\r\n\r\n                    <div style={{ display: 'flex', gap: '20px', alignItems: 'flex-start' }}>\r\n                        <div style={{ flex: 1 }}>\r\n                            {isEditing ? (\r\n                                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>\r\n                                    <label style={{ fontSize: '14px', color: '#666' }}>Name:</label>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        value={editName}\r\n                                        onChange={e => setEditName(e.target.value)}\r\n                                        style={{ padding: '8px', border: '1px solid #ddd', borderRadius: '4px', fontSize: '16px' }}\r\n                                    />\r\n                                    <label style={{ fontSize: '14px', color: '#666' }}>Avatar URL or Upload:</label>\r\n                                    <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            value={editAvatar}\r\n                                            onChange={e => setEditAvatar(e.target.value)}\r\n                                            placeholder=\"https://...\"\r\n                                            style={{ flex: 1, padding: '8px', border: '1px solid #ddd', borderRadius: '4px', fontSize: '14px' }}\r\n                                        />\r\n                                        <label style={{ cursor: 'pointer', padding: '8px 12px', backgroundColor: '#f0f0f0', border: '1px solid #ddd', borderRadius: '4px', fontSize: '14px', whiteSpace: 'nowrap' }}>\r\n                                            Upload\r\n                                            <input type=\"file\" accept=\"image/*\" style={{ display: 'none' }} onChange={(e) => handleFileUpload(e, setEditAvatar)} />\r\n                                        </label>\r\n                                    </div>\r\n                                    <label style={{ fontSize: '14px', color: '#666' }}>Bio:</label>\r\n                                    <textarea\r\n                                        value={editBio}\r\n                                        onChange={e => setEditBio(e.target.value)}\r\n                                        placeholder=\"What's up?\"\r\n                                        style={{ padding: '8px', border: '1px solid #ddd', borderRadius: '4px', minHeight: '60px', resize: 'vertical' }}\r\n                                    />\r\n                                    <div style={{ display: 'flex', gap: '10px' }}>\r\n                                        <button onClick={handleSaveProfile} title={lang === 'en' ? 'Save profile changes' : '淇濆瓨涓汉璧勬枡淇敼'} style={{ display: 'flex', alignItems: 'center', gap: '5px', padding: '6px 12px', backgroundColor: '#7B9FE0', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>\r\n                                            <Save size={16} /> Save\r\n                                        </button>\r\n                                        <button onClick={() => setIsEditing(false)} title={lang === 'en' ? 'Cancel editing' : '鍙栨秷缂栬緫'} style={{ padding: '6px 12px', backgroundColor: '#f5f5f5', color: '#333', border: '1px solid #ddd', borderRadius: '4px', cursor: 'pointer' }}>Cancel</button>\r\n                                    </div>\r\n                                </div>\r\n                            ) : (\r\n                                <div>\r\n                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>\r\n                                        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>\r\n                                            <img src={profile.avatar || 'https://api.dicebear.com/7.x/notionists/svg?seed=User'} alt=\"Me\" style={{ width: '60px', height: '60px', borderRadius: '8px', objectFit: 'cover' }} />\r\n                                            <div>\r\n                                                <h3 style={{ margin: '0 0 5px 0', fontSize: '20px' }}>{profile.name}</h3>\r\n                                                <p style={{ color: '#666', margin: 0, whiteSpace: 'pre-wrap', fontSize: '14px' }}>{profile.bio || 'Signature...'}</p>\r\n                                            </div>\r\n                                        </div>\r\n                                        <button onClick={() => setIsEditing(true)} title={lang === 'en' ? 'Edit your profile (name, avatar, bio)' : '缂栬緫涓汉璧勬枡锛堝悕瀛椼€佸ご鍍忋€佺鍚嶏級'} style={{ background: 'none', border: 'none', color: '#7B9FE0', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '5px' }}>\r\n                                            <Edit3 size={16} /> Edit\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Contacts Management Section */}\r\n                <div style={{ backgroundColor: '#fff', padding: '20px', borderRadius: '8px', border: '1px solid #eee' }}>\r\n                    <h2 style={{ margin: '0 0 20px 0', fontSize: '18px' }}>{t('Characters')}</h2>\r\n                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>\r\n                        {contacts.map(c => (\r\n                            <div key={c.id} style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '10px', border: '1px solid #f0f0f0', borderRadius: '6px' }}>\r\n                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>\r\n                                    <img src={c.avatar} alt={c.name} style={{ width: '40px', height: '40px', borderRadius: '4px' }} />\r\n                                    <div>\r\n                                        <div style={{ fontWeight: '500' }}>{c.name}</div>\r\n                                        <div style={{ fontSize: '12px', color: '#999' }}>\r\n                                            {lang === 'en' ? 'Affinity' : '濂芥劅搴?}: {c.affinity} | 馃挵 楼{(c.wallet ?? 0).toFixed(2)} | {c.is_blocked ? (lang === 'en' ? '馃毇 Blocked' : '馃毇 宸叉媺榛?) : (lang === 'en' ? 'Active' : '姝ｅ父')}\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                                <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>\r\n                                    {!!c.is_blocked && (\r\n                                        <button\r\n                                            onClick={async () => {\r\n                                                try {\r\n                                                    await fetch(`${apiUrl}/characters`, {\r\n                                                        method: 'POST', headers: { 'Content-Type': 'application/json' },\r\n                                                        body: JSON.stringify({ id: c.id, affinity: 60, is_blocked: 0 })\r\n                                                    });\r\n                                                    onCharactersUpdate?.();\r\n                                                } catch (e) { console.error(e); }\r\n                                            }}\r\n                                            style={{ background: 'none', border: '1px solid #ddd', borderRadius: '4px', color: '#7B9FE0', cursor: 'pointer', padding: '3px 8px', fontSize: '12px' }}\r\n                                            title={lang === 'en' ? 'Admin Unblock & Reset Affinity' : '绠＄悊鍛樿В灏?& 閲嶇疆濂芥劅搴?}>\r\n                                            馃敁\r\n                                        </button>\r\n                                    )}\r\n                                    <button\r\n                                        onClick={() => setEditingContact({ ...c, system_prompt: c.system_prompt || defaultGuidelines })}\r\n                                        style={{ background: 'none', border: 'none', color: '#7B9FE0', cursor: 'pointer', padding: '5px' }} title={lang === 'en' ? 'Edit API endpoint, model, persona, prompt' : '缂栬緫 API 鎺ュ彛銆佹ā鍨嬨€佷汉璁俱€佹彁绀鸿瘝'}>\r\n                                        <Edit3 size={18} />\r\n                                    </button>\r\n                                    <button\r\n                                        onClick={() => handleDeleteContact(c.id)}\r\n                                        style={{ background: 'none', border: 'none', color: '#F06B8E', cursor: 'pointer', padding: '5px' }} title={lang === 'en' ? 'Delete this character permanently' : '姘镐箙鍒犻櫎姝よ鑹?}>\r\n                                        <Trash2 size={18} />\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Group Chat Settings */}\r\n                <div style={{ backgroundColor: '#fff', padding: '20px', borderRadius: '8px', border: '1px solid #eee' }}>\r\n                    <h2 style={{ margin: '0 0 20px 0', fontSize: '18px' }}>\r\n                        {lang === 'en' ? '馃幆 Group Chat Settings' : '馃幆 缇よ亰璁剧疆'}\r\n                    </h2>\r\n\r\n                    {/* Group Context Limit */}\r\n                    <div style={{ marginBottom: '18px' }}>\r\n                        <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '14px', marginBottom: '6px' }}>\r\n                            <span>{lang === 'en' ? 'Group Context Messages' : '缇よ亰涓婁笅鏂囨秷鎭暟'}</span>\r\n                            <span>{profile.group_msg_limit || 20} <span style={{ fontSize: '12px', color: '#999' }}>{lang === 'en' ? '(rich context)' : '锛堜笂涓嬫枃涓板瘜锛?}</span></span>\r\n                        </div>\r\n                        <input type=\"range\" min=\"5\" max=\"50\" value={profile.group_msg_limit || 20}\r\n                            onChange={e => {\r\n                                const v = parseInt(e.target.value);\r\n                                setProfile(p => ({ ...p, group_msg_limit: v }));\r\n                                fetch(`${apiUrl}/user`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ group_msg_limit: v }) });\r\n                            }}\r\n                            style={{ width: '100%' }} />\r\n                        <div style={{ fontSize: '11px', color: '#999', marginTop: '4px' }}>\r\n                            {lang === 'en' ? 'Number of recent messages each AI can see in group chat. Higher = richer context, but slightly slower.'\r\n                                : '鎺у埗姣忎釜 AI 瑙掕壊鍦ㄧ兢鑱婂洖澶嶅墠鑳界湅鍒扮殑鏈€杩戞秷鎭暟閲忋€傝秺楂樹笂涓嬫枃瓒婁赴瀵岋紝浣嗗搷搴旂◢鎱€?}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Skip Reply Chance */}\r\n                    <div style={{ marginBottom: '18px' }}>\r\n                        <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '14px', marginBottom: '6px' }}>\r\n                            <span>{lang === 'en' ? 'Chance to Skip Reply' : '涓嶅洖澶嶆鐜?}</span>\r\n                            <span>{Math.round((profile.group_skip_rate || 0) * 100)}%</span>\r\n                        </div>\r\n                        <input type=\"range\" min=\"0\" max=\"50\" value={Math.round((profile.group_skip_rate || 0) * 100)}\r\n                            onChange={e => {\r\n                                const v = parseInt(e.target.value) / 100;\r\n                                setProfile(p => ({ ...p, group_skip_rate: v }));\r\n                                fetch(`${apiUrl}/user`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ group_skip_rate: v }) });\r\n                            }}\r\n                            style={{ width: '100%' }} />\r\n                        <div style={{ fontSize: '11px', color: '#999', marginTop: '4px' }}>\r\n                            {lang === 'en' ? 'Probability each character randomly skips replies. 0% = always reply, 50% = skip ~every other.'\r\n                                : '姣忎釜瑙掕壊闅忔満璺宠繃鍥炲鐨勬鐜囥€?% = 姣忔潯蹇呭洖锛?0% = 绾︽瘡2鏉¤烦1鏉°€?}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Proactive Group Messaging 鈥?frequency slider */}\r\n                    <div style={{ marginBottom: '18px' }}>\r\n                        <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '14px', marginBottom: '6px' }}>\r\n                            <span>{lang === 'en' ? 'Proactive Messaging Frequency' : '缇よ亰涓诲姩鍙戞秷鎭鐜?}</span>\r\n                            <span>\r\n                                {!profile.group_proactive_enabled\r\n                                    ? (lang === 'en' ? 'Off' : '鍏抽棴')\r\n                                    : `${profile.group_interval_min || 3}~${profile.group_interval_max || 10} ${lang === 'en' ? 'min' : '鍒嗛挓'}`}\r\n                            </span>\r\n                        </div>\r\n                        <input type=\"range\" min=\"0\" max=\"10\"\r\n                            value={(() => {\r\n                                if (!profile.group_proactive_enabled) return 0;\r\n                                const avg = ((profile.group_interval_min || 3) + (profile.group_interval_max || 10)) / 2;\r\n                                return Math.max(1, Math.min(10, Math.round(11 - avg)));\r\n                            })()}\r\n                            onChange={e => {\r\n                                const level = parseInt(e.target.value);\r\n                                if (level === 0) {\r\n                                    setProfile(p => ({ ...p, group_proactive_enabled: 0 }));\r\n                                    fetch(`${apiUrl}/user`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ group_proactive_enabled: 0 }) });\r\n                                } else {\r\n                                    const avg = 11 - level;\r\n                                    const min = Math.max(1, avg - 2);\r\n                                    const max = avg + 2;\r\n                                    setProfile(p => ({ ...p, group_proactive_enabled: 1, group_interval_min: min, group_interval_max: max }));\r\n                                    fetch(`${apiUrl}/user`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ group_proactive_enabled: 1, group_interval_min: min, group_interval_max: max }) });\r\n                                }\r\n                            }}\r\n                            style={{ width: '100%' }} />\r\n                        <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '11px', color: '#999', marginTop: '4px' }}>\r\n                            <span>{lang === 'en' ? 'Off' : '鍏抽棴'}</span>\r\n                            <span>{lang === 'en' ? 'Very frequent' : '闈炲父棰戠箒'}</span>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Jealousy Chance */}\r\n                    <div style={{ marginBottom: '10px' }}>\r\n                        <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '14px', marginBottom: '6px' }}>\r\n                            <span>{lang === 'en' ? '馃挌 Jealousy Chance' : '馃挌 瀚夊姒傜巼'}</span>\r\n                            <span>{Math.round((profile.jealousy_chance ?? 0.3) * 100)}%</span>\r\n                        </div>\r\n                        <input type=\"range\" min=\"0\" max=\"100\" value={Math.round((profile.jealousy_chance ?? 0.3) * 100)}\r\n                            onChange={e => {\r\n                                const v = parseInt(e.target.value) / 100;\r\n                                setProfile(p => ({ ...p, jealousy_chance: v }));\r\n                                fetch(`${apiUrl}/user`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ jealousy_chance: v }) });\r\n                            }}\r\n                            style={{ width: '100%' }} />\r\n                        <div style={{ fontSize: '11px', color: '#999', marginTop: '4px' }}>\r\n                            {lang === 'en' ? 'Probability that a character gets jealous when you chat with someone else. 0% = never, 100% = always.'\r\n                                : '褰撲綘鍜屽埆浜鸿亰澶╂椂锛岃鑹蹭骇鐢熷珘濡掔殑姒傜巼銆?% = 浠庝笉锛?00% = 鎬绘槸銆?}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Wallet */}\r\n                <div style={{ backgroundColor: '#fff', padding: '20px', borderRadius: '8px', border: '1px solid #eee' }}>\r\n                    <h2 style={{ margin: '0 0 15px 0', fontSize: '18px' }}>\r\n                        {lang === 'en' ? '馃挵 Wallet' : '馃挵 閽卞寘'}\r\n                    </h2>\r\n                    <div style={{ fontSize: '14px', color: '#666' }}>\r\n                        {lang === 'en' ? 'Wallet Balance (楼):' : '閽卞寘浣欓锛堝厓锛夛細'}\r\n                        <span style={{ fontSize: '24px', fontWeight: '700', color: '#7B9FE0', marginLeft: '10px' }}>\r\n                            楼{(profile.wallet ?? 100).toFixed(2)}\r\n                        </span>\r\n                    </div>\r\n                </div>\r\n\r\n            </div>\r\n\r\n            {/* Character Edit Modal */}\r\n            {editingContact && (\r\n                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>\r\n                    <div style={{ backgroundColor: '#fff', padding: '20px', borderRadius: '8px', width: '90%', maxWidth: '500px', display: 'flex', flexDirection: 'column', gap: '15px', maxHeight: '90vh', overflowY: 'auto' }}>\r\n                        <h3 style={{ margin: 0 }}>Edit Character Setting: {editingContact.name}</h3>\r\n\r\n                        <div style={{ display: 'flex', gap: '10px' }}>\r\n                            <label style={{ flex: 1, display: 'flex', flexDirection: 'column', fontSize: '14px', color: '#666' }}>\r\n                                {t('Name')}:\r\n                                <input type=\"text\" value={editingContact.name || ''} onChange={(e) => setEditingContact({ ...editingContact, name: e.target.value })} style={{ padding: '8px', marginTop: '5px', border: '1px solid #ddd', borderRadius: '4px' }} />\r\n                            </label>\r\n                            <label style={{ flex: 1, display: 'flex', flexDirection: 'column', fontSize: '14px', color: '#666' }}>\r\n                                {t('Avatar URL')}:\r\n                                <div style={{ display: 'flex', gap: '5px', marginTop: '5px' }}>\r\n                                    <input type=\"text\" value={editingContact.avatar || ''} onChange={(e) => setEditingContact({ ...editingContact, avatar: e.target.value })} style={{ flex: 1, padding: '8px', border: '1px solid #ddd', borderRadius: '4px' }} />\r\n                                    <label style={{ cursor: 'pointer', padding: '8px 12px', backgroundColor: '#f0f0f0', border: '1px solid #ddd', borderRadius: '4px', fontSize: '14px', whiteSpace: 'nowrap' }}>\r\n                                        Upload\r\n                                        <input type=\"file\" accept=\"image/*\" style={{ display: 'none' }} onChange={(e) => handleFileUpload(e, (url) => setEditingContact({ ...editingContact, avatar: url }))} />\r\n                                    </label>\r\n                                </div>\r\n                            </label>\r\n                        </div>\r\n\r\n                        <label style={{ display: 'flex', flexDirection: 'column', fontSize: '14px', color: '#666' }}>\r\n                            {t('API Endpoint')}:\r\n                            <input type=\"text\" value={editingContact.api_endpoint || ''} onChange={(e) => setEditingContact({ ...editingContact, api_endpoint: e.target.value })} style={{ padding: '8px', marginTop: '5px', border: '1px solid #ddd', borderRadius: '4px' }} />\r\n                        </label>\r\n\r\n                        <label style={{ display: 'flex', flexDirection: 'column', fontSize: '14px', color: '#666' }}>\r\n                            {t('API Key')}:\r\n                            <input type=\"password\" value={editingContact.api_key || ''} onChange={(e) => setEditingContact({ ...editingContact, api_key: e.target.value })} placeholder=\"sk-...\" style={{ padding: '8px', marginTop: '5px', border: '1px solid #ddd', borderRadius: '4px' }} />\r\n                        </label>\r\n\r\n                        <div style={{ display: 'flex', gap: '10px' }}>\r\n                            <label style={{ flex: 1, display: 'flex', flexDirection: 'column', fontSize: '14px', color: '#666' }}>\r\n                                {t('Model Name')}:\r\n                                <div style={{ display: 'flex', gap: '5px', marginTop: '5px' }}>\r\n                                    <input type=\"text\" value={editingContact.model_name || ''} onChange={(e) => setEditingContact({ ...editingContact, model_name: e.target.value })} style={{ flex: 1, padding: '8px', border: '1px solid #ddd', borderRadius: '4px' }} />\r\n                                    <button type=\"button\" onClick={() => fetchModels(editingContact.api_endpoint, editingContact.api_key, setMainModels, setMainModelFetching, setMainModelError)} disabled={mainModelFetching}\r\n                                        style={{ padding: '6px 10px', background: '#7B9FE0', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', whiteSpace: 'nowrap', display: 'flex', alignItems: 'center', gap: '4px' }}>\r\n                                        <RefreshCw size={13} /> {mainModelFetching ? '...' : t('Fetch Models')}\r\n                                    </button>\r\n                                </div>\r\n                                {mainModelError && <span style={{ color: '#F06B8E', fontSize: '12px' }}>{mainModelError}</span>}\r\n                                {mainModels.length > 0 && (\r\n                                    <select defaultValue=\"\" onChange={e => setEditingContact({ ...editingContact, model_name: e.target.value })}\r\n                                        style={{ marginTop: '4px', padding: '6px', border: '1px solid #ddd', borderRadius: '4px', fontSize: '13px' }}>\r\n                                        <option value=\"\" disabled>鈹€鈹€ 閫夋嫨妯″瀷 鈹€鈹€</option>\r\n                                        {mainModels.map(m => <option key={m} value={m}>{m}</option>)}\r\n                                    </select>\r\n                                )}\r\n                            </label>\r\n                            <label style={{ flex: 1, display: 'flex', flexDirection: 'column', fontSize: '14px', color: '#666' }}>\r\n                                {t('Max Output Tokens')}:\r\n                                <input type=\"number\" value={editingContact.max_tokens ?? 800} onChange={(e) => setEditingContact({ ...editingContact, max_tokens: parseInt(e.target.value) || 800 })} style={{ padding: '8px', marginTop: '5px', border: '1px solid #ddd', borderRadius: '4px' }} />\r\n                            </label>\r\n                        </div>\r\n                        <div style={{ display: 'flex', gap: '20px' }}>\r\n                            <label style={{ flex: 1, display: 'flex', flexDirection: 'column', fontSize: '14px', color: '#666' }}>\r\n                                Min Interval (mins):\r\n                                <div className=\"autopulse-interval-control\" style={{ marginTop: '5px' }}>\r\n                                    <input type=\"range\" min=\"0.1\" max=\"120\" step=\"0.1\" value={editingContact.interval_min || 0.1} onChange={(e) => setEditingContact({ ...editingContact, interval_min: parseFloat(e.target.value) })} />\r\n                                    <input type=\"number\" step=\"0.1\" value={editingContact.interval_min || 0} onChange={(e) => setEditingContact({ ...editingContact, interval_min: parseFloat(e.target.value) })} className=\"autopulse-number-input\" />\r\n                                </div>\r\n                            </label>\r\n                            <label style={{ flex: 1, display: 'flex', flexDirection: 'column', fontSize: '14px', color: '#666' }}>\r\n                                Max Interval (mins):\r\n                                <div className=\"autopulse-interval-control\" style={{ marginTop: '5px' }}>\r\n                                    <input type=\"range\" min=\"0.1\" max=\"120\" step=\"0.1\" value={editingContact.interval_max || 0.1} onChange={(e) => setEditingContact({ ...editingContact, interval_max: parseFloat(e.target.value) })} />\r\n                                    <input type=\"number\" step=\"0.1\" value={editingContact.interval_max || 0} onChange={(e) => setEditingContact({ ...editingContact, interval_max: parseFloat(e.target.value) })} className=\"autopulse-number-input\" />\r\n                                </div>\r\n                            </label>\r\n                        </div>\r\n\r\n                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginTop: '10px', marginBottom: '5px', background: '#f9f9f9', padding: '10px', borderRadius: '4px', border: '1px solid #eee' }}>\r\n                            <label style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '13px', color: '#333', cursor: 'pointer' }}>\r\n                                <input type=\"checkbox\" checked={editingContact.sys_proactive !== 0} onChange={(e) => setEditingContact({ ...editingContact, sys_proactive: e.target.checked ? 1 : 0 })} />\r\n                                {t('Toggle Proactive Messages')}\r\n                            </label>\r\n                            <label style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '13px', color: '#333', cursor: 'pointer' }}>\r\n                                <input type=\"checkbox\" checked={editingContact.sys_timer !== 0} onChange={(e) => setEditingContact({ ...editingContact, sys_timer: e.target.checked ? 1 : 0 })} />\r\n                                {t('Toggle Timer Actions')}\r\n                            </label>\r\n                            <label style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '13px', color: '#333', cursor: 'pointer' }}>\r\n                                <input type=\"checkbox\" checked={editingContact.sys_pressure !== 0} onChange={(e) => setEditingContact({ ...editingContact, sys_pressure: e.target.checked ? 1 : 0 })} />\r\n                                {t('Toggle Pressure System')}\r\n                            </label>\r\n                            <label style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '13px', color: '#333', cursor: 'pointer' }}>\r\n                                <input type=\"checkbox\" checked={editingContact.sys_jealousy !== 0} onChange={(e) => setEditingContact({ ...editingContact, sys_jealousy: e.target.checked ? 1 : 0 })} />\r\n                                {t('Toggle Jealousy System')}\r\n                            </label>\r\n                        </div>\r\n\r\n                        <div style={{ display: 'flex', flexDirection: 'column', gap: '10px', marginTop: '10px', padding: '10px', background: '#f5f7fa', borderRadius: '4px', border: '1px solid #e2e8f0' }}>\r\n                            <strong style={{ fontSize: '13px', color: '#4a5568' }}>Memory Extraction AI (Small Model)</strong>\r\n                            <label style={{ display: 'flex', flexDirection: 'column', fontSize: '14px', color: '#666' }}>\r\n                                {t('Memory API Endpoint')}:\r\n                                <input type=\"text\" value={editingContact.memory_api_endpoint || ''} onChange={(e) => setEditingContact({ ...editingContact, memory_api_endpoint: e.target.value })} placeholder=\"e.g. https://api.openai.com/v1\" style={{ padding: '8px', marginTop: '5px', border: '1px solid #ddd', borderRadius: '4px' }} />\r\n                            </label>\r\n                            <label style={{ display: 'flex', flexDirection: 'column', fontSize: '14px', color: '#666' }}>\r\n                                {t('Memory API Key')}:\r\n                                <input type=\"password\" value={editingContact.memory_api_key || ''} onChange={(e) => setEditingContact({ ...editingContact, memory_api_key: e.target.value })} style={{ padding: '8px', marginTop: '5px', border: '1px solid #ddd', borderRadius: '4px' }} />\r\n                            </label>\r\n                            <label style={{ display: 'flex', flexDirection: 'column', fontSize: '14px', color: '#666' }}>\r\n                                Memory Model Name:\r\n                                <div style={{ display: 'flex', gap: '5px', marginTop: '5px' }}>\r\n                                    <input type=\"text\" value={editingContact.memory_model_name || ''} onChange={(e) => setEditingContact({ ...editingContact, memory_model_name: e.target.value })} placeholder=\"e.g. gpt-4o-mini\" style={{ flex: 1, padding: '8px', border: '1px solid #ddd', borderRadius: '4px' }} />\r\n                                    <button type=\"button\" onClick={() => fetchModels(editingContact.memory_api_endpoint, editingContact.memory_api_key, setMemModels, setMemModelFetching, setMemModelError)} disabled={memModelFetching}\r\n                                        style={{ padding: '6px 10px', background: '#7B9FE0', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer', whiteSpace: 'nowrap', display: 'flex', alignItems: 'center', gap: '4px' }}>\r\n                                        <RefreshCw size={13} /> {memModelFetching ? '...' : '鎷夊彇'}\r\n                                    </button>\r\n                                </div>\r\n                                {memModelError && <span style={{ color: '#F06B8E', fontSize: '12px' }}>{memModelError}</span>}\r\n                                {memModels.length > 0 && (\r\n                                    <select defaultValue=\"\" onChange={e => setEditingContact({ ...editingContact, memory_model_name: e.target.value })}\r\n                                        style={{ marginTop: '4px', padding: '6px', border: '1px solid #ddd', borderRadius: '4px', fontSize: '13px' }}>\r\n                                        <option value=\"\" disabled>鈹€鈹€ 閫夋嫨妯″瀷 鈹€鈹€</option>\r\n                                        {memModels.map(m => <option key={m} value={m}>{m}</option>)}\r\n                                    </select>\r\n                                )}\r\n                            </label>\r\n                        </div>\r\n\r\n                        <label style={{ display: 'flex', flexDirection: 'column', fontSize: '14px', color: '#666', marginTop: '10px' }}>\r\n                            Persona (Prompt Info):\r\n                            <textarea value={editingContact.persona || ''} onChange={(e) => setEditingContact({ ...editingContact, persona: e.target.value })} style={{ padding: '8px', marginTop: '5px', border: '1px solid #ddd', borderRadius: '4px', minHeight: '80px', resize: 'vertical' }} />\r\n                        </label>\r\n\r\n                        <label style={{ display: 'flex', flexDirection: 'column', fontSize: '14px', color: '#666', marginTop: '10px' }}>\r\n                            System Guidelines (Core Rules & Tags):\r\n                            <textarea\r\n                                value={editingContact.system_prompt || ''}\r\n                                onChange={(e) => setEditingContact({ ...editingContact, system_prompt: e.target.value })}\r\n                                placeholder=\"Leave blank to use default system guidelines.\"\r\n                                style={{ padding: '8px', marginTop: '5px', border: '1px solid #ddd', borderRadius: '4px', minHeight: '120px', resize: 'vertical', fontFamily: 'monospace', fontSize: '12px' }}\r\n                            />\r\n                        </label>\r\n\r\n                        <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end', marginTop: '10px' }}>\r\n                            <button onClick={() => setEditingContact(null)} style={{ padding: '8px 16px', background: '#f0f0f0', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>Cancel</button>\r\n                            <button onClick={handleSaveContact} style={{ padding: '8px 16px', background: '#7B9FE0', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>Save Settings</button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </>\r\n    );\r\n}\r\n\r\nexport default SettingsPanel;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\components\\TransferModal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Administrator\\.gemini\\antigravity\\scratch\\ChatPulse\\client\\src\\main.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
